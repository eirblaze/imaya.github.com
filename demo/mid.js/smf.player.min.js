/** @license mid.js 2012 - imaya [ https://github.com/imaya/mid.js ] The MIT License */
(function() {'use strict';function n(b){throw b;}var q=void 0,r=null,s=!1,t,u=this;function x(b,a){var d=b.split("."),c=u;!(d[0]in c)&&c.execScript&&c.execScript("var "+d[0]);for(var e;d.length&&(e=d.shift());)!d.length&&a!==q?c[e]=a:c=c[e]?c[e]:c[e]={}}function y(b){var a=z;function d(){}d.prototype=a.prototype;b.superClass_=a.prototype;b.prototype=new d;b.prototype.constructor=b};var B=u.Uint8Array!==q&&u.Uint16Array!==q&&u.Uint32Array!==q;function z(b,a,d){this.subtype=b;this.deltaTime=a;this.time=d}function C(b,a,d,c,e,g){z.call(this,b,a,d);this.channel=c;this.parameter1=e;this.parameter2=g}y(C);function D(b,a,d,c){z.call(this,b,a,d);this.data=c}y(D);function E(b,a,d,c){z.call(this,b,a,d);this.data=c}y(E);function F(b,a){a=a||{};this.input=b;this.ip=a.index||0}
F.prototype.parse=function(){var b=this.input,a=this.ip,d=this.header={},c=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"melo"!==c&&n(Error("invalid MFi signature:"+c));d.fileLength=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;d.trackOffset=(b[a++]<<16|b[a++])+a;d.dataMajorType=b[a++];d.dataMinorType=b[a++];d.numberOfTracks=b[a++];this.ip=a;for(var b=this.input,a=this.ip,d=this.dataInformation={},e;a<this.header.trackOffset;)switch(c=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),e=b[a++]<<
8|b[a++],c){case "titl":case "copy":case "vers":case "date":case "prot":d[c]=String.fromCharCode.apply(r,B?b.subarray(a,a+=e):b.slice(a,a+=e));break;case "sorc":d[c]=b[a++];break;case "note":d[c]=b[a++]<<8|b[a++];break;default:d[c]=B?b.subarray(a,a+=e):b.slice(a,a+=e)}this.ip=a;var b=this.input,a=this.ip,g,h,f,d=this.tracks=[],j,c=0;for(e=this.header.numberOfTracks;c<e;++c){g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"trac"!==g&&n(Error("invalid track signature:"+g));g=b[a++]<<24|b[a++]<<16|
b[a++]<<8|b[a++];g=a+g;for(j=d[c]=[];a<g;){f={};f.deltaTime=b[a++];h=b[a++];if(255!==h)f.type="note",f.subType="Note",f.voice=h>>6,f.key=h&63,f.length=b[a++],1===this.dataInformation.note&&(h=b[a++],f.velocity=h>>2,f.octaveShift=h&3);else switch(f.type="meta",h=b[a++],h>>4){case 11:switch(h&15){case 0:f.subType="MasterVolume";f.value=b[a++];break;case 10:f.subType="DrumScale";f.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:n(Error("unknown message type:"+h.toString(16)))}break;case 12:f.subType=
"SetTempo";f.value={timeBase:7===(h&7)?NaN:Math.pow(2,h&7)*(0===(h&8)?6:15),tempo:b[a++]};break;case 13:switch(h&15){case 0:f.subType="Point";f.value=b[a++];break;case 13:f.subType="Loop";f.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:f.subType="Nop";f.value=b[a++];break;case 15:f.subType="EndOfTrack";f.value=b[a++];break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 14:switch(h&15){case 0:f.subType="InstrumentLowPart";f.value={part:b[a]>>6,instrument:b[a++]&
63};break;case 1:f.subType="InstrumentHighPart";f.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:f.subType="Volume";f.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:f.subType="Valance";f.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:f.subType="PitchBend";f.value={part:b[a]>>6,value:b[a++]&63};break;case 5:f.subType="ChannelAssign";f.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:f.subType="VolumeChange";f.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:f.subType=
"PitchBendRange";f.value={part:b[a]>>6,value:b[a++]&63};break;case 9:f.subType="MasterCoarseTuning";f.value={part:b[a]>>6,value:b[a++]&63};break;case 10:f.subType="Modulation";f.value={part:b[a]>>6,depth:b[a++]&63};break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 15:switch(h&15){case 0:f.subType="EditInstrument";h=f;var m=b[a++]<<8|b[a++],m=a+m,i=[],k=q;for(1!==b[a++]&&n(Error("invalid EditInstrument const value:"+b[a-1]));a<m;)k={},k.part=b[a++]>>4&3,k.modulator={ML:b[a]>>
5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},k.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},k.octaveSelect=b[a++]&3,i.push(k);h.value=i;break;case 1:f.subType="Vibrato";h=f;a++;a++;1!==b[a++]&&n(Error("invalid Vibrato const value:"+
b[a-1]));m={part:b[a++]>>5&3,"switch":b[a++]>>6};h.value=m;break;case 15:f.subType="DeviceSpecific";h=f;m=b[a++]<<8|b[a++];m=a+m;17!==b[a++]&&n(Error("invalid DeviceSpecific const value:"+b[a-1]));m={data:B?b.subarray(a,a+=m-a):b.slice(a,a+=m-a)};h.value=m;break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;default:n(Error("unkwnon message type:"+h.toString(16)))}j.push(f)}a=g}this.ip=a};
F.prototype.deltaTimeToByteArray=function(b){for(var a=[];128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a};function G(b,a){a=a||{};this.input=b;this.ip=a.index||0;this.length=a.length||b.length-this.ip;this.offset=this.ip;this.padding=a.padding!==q?a.padding:!0;this.bigEndian=a.bigEndian!==q?a.bigEndian:s}
G.prototype.parse=function(){var b=this.length+this.offset;for(this.chunkList=[];this.ip<b;){var a=this.input,d=this.ip,c=q;this.chunkList.push({type:String.fromCharCode(a[d++],a[d++],a[d++],a[d++]),size:c=this.bigEndian?(a[d++]<<24|a[d++]<<16|a[d++]<<8|a[d++])>>>0:(a[d++]|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,offset:d});d+=c;this.padding&&1===(d-this.offset&1)&&d++;this.ip=d}};function H(b,a){var d=b.chunkList[a];return d===q?r:d};function I(b,a){a=a||{};this.input=b;this.parserOption=a.parserOption}
I.prototype.parse=function(){var b=new G(this.input,this.parserOption);b.parse();1!==b.chunkList.length&&n(Error("wrong chunk length"));b=H(b,0);b===r&&n(Error("chunk not found"));var a=this.input,d=b.offset,c;"RIFF"!==b.type&&n(Error("invalid chunk type:",b.type));c=String.fromCharCode(a[d++],a[d++],a[d++],a[d++]);"sfbk"!==c&&n(Error("invalid signature:",c));b=new G(a,{index:d,length:b.size-4});b.parse();3!==b.chunkList.length&&n(Error("invalid sfbk structure"));a=H(b,0);d=this.input;c=a.offset;
var e;"LIST"!==a.type&&n(Error("invalid chunk type:",a.type));e=String.fromCharCode(d[c++],d[c++],d[c++],d[c++]);"INFO"!==e&&n(Error("invalid signature:",e));(new G(d,{index:c,length:a.size-4})).parse();a=H(b,1);d=this.input;c=a.offset;"LIST"!==a.type&&n(Error("invalid chunk type:",a.type));e=String.fromCharCode(d[c++],d[c++],d[c++],d[c++]);"sdta"!==e&&n(Error("invalid signature:",e));a=new G(d,{index:c,length:a.size-4});a.parse();1!==a.chunkList.length&&n(Error("TODO"));this.samplingData=H(a,0);
b=H(b,2);a=this.input;d=b.offset;"LIST"!==b.type&&n(Error("invalid chunk type:",b.type));c=String.fromCharCode(a[d++],a[d++],a[d++],a[d++]);"pdta"!==c&&n(Error("invalid signature:",c));b=new G(a,{index:d,length:b.size-4});b.parse();9!==b.chunkList.length&&n(Error("invalid pdta chunk"));a=H(b,0);d=this.input;c=a.offset;e=this.presetHeader=[];var g=a.offset+a.size;for("phdr"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({presetName:String.fromCharCode.apply(r,d.subarray(c,c+=20)),preset:d[c++]|
d[c++]<<8,bank:d[c++]|d[c++]<<8,presetBagIndex:d[c++]|d[c++]<<8,library:(d[c++]|d[c++]<<8|d[c++]<<16|d[c++]<<24)>>>0,genre:(d[c++]|d[c++]<<8|d[c++]<<16|d[c++]<<24)>>>0,morphology:(d[c++]|d[c++]<<8|d[c++]<<16|d[c++]<<24)>>>0});a=H(b,1);d=this.input;c=a.offset;e=this.presetZone=[];g=a.offset+a.size;for("pbag"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({presetGeneratorIndex:d[c++]|d[c++]<<8,presetModulatorIndex:d[c++]|d[c++]<<8});a=H(b,2);d=this.input;c=a.offset;e=this.presetZoneModulator=
[];g=a.offset+a.size;for("pmod"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({modulatorSourceOper:d[c++]|d[c++]<<8,modulatorDestinationOper:d[c++]|d[c++]<<8,amount:d[c++]|d[c++]<<8,modulatorAmountSourceOper:d[c++]|d[c++]<<8,modulatorTransformOper:d[c++]|d[c++]<<8});a=H(b,3);"pgen"!==a.type&&n(Error("invalid chunk type:",a.type));this.presetZoneGenerator=J(this,a);a=H(b,4);d=this.input;c=a.offset;e=this.instrument=[];g=a.offset+a.size;for("inst"!==a.type&&n(Error("invalid chunk type:",
a.type));c<g;)e.push({instrumentName:String.fromCharCode.apply(r,d.subarray(c,c+=20)),instrumentBagIndex:d[c++]|d[c++]<<8});a=H(b,5);d=this.input;c=a.offset;e=this.instrumentZone=[];g=a.offset+a.size;for("ibag"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({instrumentGeneratorIndex:d[c++]|d[c++]<<8,instrumentModulatorIndex:d[c++]|d[c++]<<8});a=H(b,6);d=this.input;c=a.offset;e=this.instrumentZoneModulator=[];g=a.offset+a.size;for("imod"!==a.type&&n(Error("invalid chunk type:",a.type));c<
g;)e.push({modulatorSourceOper:d[c++]|d[c++]<<8,modulatorDestinationOper:d[c++]|d[c++]<<8,amount:d[c++]|d[c++]<<8,modulatorAmountSourceOper:d[c++]|d[c++]<<8,modulatorTransformOper:d[c++]|d[c++]<<8});a=H(b,7);"igen"!==a.type&&n(Error("invalid chunk type:",a.type));this.instrumentZoneGenerator=J(this,a);b=H(b,8);a=this.input;d=b.offset;c=this.sampleHeader=[];e=b.offset+b.size;for("shdr"!==b.type&&n(Error("invalid chunk type:",b.type));d<e;)c.push({sampleName:String.fromCharCode.apply(r,a.subarray(d,
d+=20)),start:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,end:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,startLoop:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,endLoop:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,sampleRate:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,originalPitch:a[d++],pitchCorrection:a[d++]<<24>>24,sampleLink:a[d++]|a[d++]<<8,sampleType:a[d++]|a[d++]<<8})};
function J(b,a){for(var d=b.input,c=a.offset,e=a.offset+a.size,g,h,f=[];c<e;)if(g=d[c++]|d[c++]<<8,h=K[g],h===q)f.push({type:h,value:{code:g,amount:d[c]|d[c+1]<<8<<16>>16,lo:d[c++],hi:d[c++]}});else switch(h){case "keyRange":case "velRange":case "keynum":case "velocity":f.push({type:h,value:{lo:d[c++],hi:d[c++]}});break;default:f.push({type:h,value:{amount:d[c++]|d[c++]<<8<<16>>16}})}return f}
I.prototype.createInstrument=function(){var b=this.instrument,a=this.instrumentZone,d=[],c,e,g,h,f,j,m,i,k,l;i=0;for(k=b.length;i<k;++i){c=b[i].instrumentBagIndex;e=b[i+1]?b[i+1].instrumentBagIndex:a.length;g=[];for(l=e;c<l;++c){j=[];h=a[c].instrumentGeneratorIndex;f=a[c+1]?a[c+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length;e={unknown:[]};for(m=f;h<m;++h)j.push(this.instrumentZoneGenerator[h]),f=this.instrumentZoneGenerator[h],"unknown"===f.type?e.unknown.push(f.value):e[f.type]=
f.value;f=[];h=a[c].instrumentModulatorIndex;for(m=a[c+1]?a[c+1].instrumentModulatorIndex:this.instrumentZoneModulator.length;h<m;++h)f.push(this.instrumentZoneModulator[h]);g.push({generator:e,generatorSequence:j,modulator:f})}d.push({name:b[i].instrumentName,info:g})}return d};
var K=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",,"chorusEffectsSend","reverbEffectsSend","pan",,,,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay",
"delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",,"scaleTuning","exclusiveClass","overridingRootKey"];function M(b,a){a=a||{};a.padding=s;a.bigEndian=!0;this.input=b;this.ip=a.index||0;this.chunkIndex=0;this.riffParser_=new G(b,a);this.tracks=[];this.plainTracks=[]}M.prototype.parse=function(){var b,a;this.riffParser_.parse();b=H(this.riffParser_,this.chunkIndex++);a=this.input;var d=b.offset;(!b||"MThd"!==b.type)&&n(Error("invalid header signature"));this.formatType=a[d++]<<8|a[d++];this.numberOfTracks=a[d++]<<8|a[d++];this.timeDivision=a[d++]<<8|a[d++];b=0;for(a=this.numberOfTracks;b<a;++b)N(this)};
function N(b){function a(){var a=0,b;do b=c[e++],a=a<<7|b&127;while(0!==(b&128));return a}var d=H(b.riffParser_,b.chunkIndex++),c=b.input,e=d.offset,g,h,f,j,m,i,k=0,l,p;(!d||"MTrk"!==d.type)&&n(Error("invalid header signature"));for(var d=d.offset+d.size,w=[],v=[];e<d;){g=a();k+=g;l=e;p=c[e++];h=p>>4&15;f=p&15;8>h?(h=j,f=m,p=j<<4|m,e--,l--):(j=h,m=f);var A=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(h){case 8:case 9:case 10:case 11:case 13:case 14:i=
new C(A[h],g,k,f,c[e++],c[e++]);break;case 12:i=new C(A[h],g,k,f,c[e++]);break;case 15:switch(f){case 0:i=a();247!==c[e+i-1]&&n(Error("invalid SysEx event"));i=new D("SystemExclusive",g,k,B?c.subarray(e,(e+=i)-1):c.slice(e,(e+=i)-1));break;case 7:i=a();i=new D("SystemExclusive(F7)",g,k,B?c.subarray(e,e+=i):c.slice(e,e+=i));break;case 15:h=c[e++];i=a();switch(h){case 0:i=new E("SequenceNumber",g,k,[c[e++],c[e++]]);break;case 1:i=new E("TextEvent",g,k,[String.fromCharCode.apply(r,B?c.subarray(e,e+=
i):c.slice(e,e+=i))]);break;case 2:i=new E("CopyrightNotice",g,k,[String.fromCharCode.apply(r,B?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 3:i=new E("SequenceTrackName",g,k,[String.fromCharCode.apply(r,B?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 4:i=new E("InstrumentName",g,k,[String.fromCharCode.apply(r,B?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 5:i=new E("Lyrics",g,k,[String.fromCharCode.apply(r,B?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 6:i=new E("Marker",g,k,[String.fromCharCode.apply(r,
B?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 7:i=new E("CuePoint",g,k,[String.fromCharCode.apply(r,B?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 32:i=new E("MidiChannelPrefix",g,k,[c[e++]]);break;case 47:i=new E("EndOfTrack",g,k,[]);break;case 81:i=new E("SetTempo",g,k,[c[e++]<<16|c[e++]<<8|c[e++]]);break;case 84:i=new E("SmpteOffset",g,k,[c[e++],c[e++],c[e++],c[e++],c[e++]]);break;case 88:i=new E("TimeSignature",g,k,[c[e++],c[e++],c[e++],c[e++]]);break;case 89:i=new E("KeySignature",g,
k,[c[e++],c[e++]]);break;case 127:i=new E("SequencerSpecific",g,k,[B?c.subarray(e,e+=i):c.slice(e,e+=i)]);break;default:i=new E("Unknown",g,k,[h,B?c.subarray(e,e+=i):c.slice(e,e+=i)])}break;default:u.console.log("unknown message:",p.toString(16))}break;default:n(Error("invalid status"))}g=e-l;l=B?c.subarray(l,l+g):c.slice(l,l+g);l[0]=p;i instanceof C&&("NoteOn"===i.subtype&&0===i.parameter2)&&(i.subtype=A[8],l=[128|i.channel,i.parameter1,i.parameter2],B&&(l=new Uint8Array(l)));v.push(l);w.push(i)}b.tracks.push(w);
b.plainTracks.push(v)};function P(){this.tempo=5E5;this.ready=s;this.position=0;this.enableLoop=this.enableMFiLoop=this.enableFalcomLoop=this.enableCC111Loop=s;this.pitch=1}t=P.prototype;t.setCC111Loop=function(b){this.enableCC111Loop=b};t.setFalcomLoop=function(b){this.enableFalcomLoop=b};t.setMFiLoop=function(b){this.enableMFiLoop=b};t.setLoop=function(b){this.enableLoop=b};
t.stop=function(){var b;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(b=0;16>b;++b)this.webMidiLink.postMessage("midi,b"+b.toString(16)+",78,0","*")};function Q(b){b.stop();b.tempo=5E5;b.position=0;b.pause=s;b.track=r;b.resume=-1;b.sequence=r;clearTimeout(b.timer)}t.play=function(){this.webMidiLink||n(Error("WebMidiLink not found"));this.ready?R(this):window.addEventListener("message",function(b){"link,ready"===b.data&&(this.ready=!0,R(this))}.bind(this),s)};
t.setWebMidiLink=function(b){var a;a=document.createElement("iframe");a.src=b||"http://www.g200kg.com/en/docs/gmplayer/";a.width=a.height="600";document.body.appendChild(a);this.webMidiLink=a.contentWindow;window.addEventListener("message",function(a){"link,ready"===a.data&&(this.ready=!0)}.bind(this),s)};t.setPitch=function(b){this.pitch=b};
function R(b){function a(){var b=c[g].time,j=c.length,m,i;if(this.pause)this.resume=Date.now()-this.resume;else{do{m=c[g].event;"SetTempo"===m.subtype&&(this.tempo=m.data[0]);"ControlChange"===m.subtype&&111===m.parameter1&&(h[0]={pos:g});if("Marker"===m.subtype&&("A"===m.data[0]&&(h[0]={pos:g}),"B"===m.data[0]&&this.enableFalcomLoop&&h[0]&&"number"===typeof h[0].pos)){g=h[0].pos;this.timer=setTimeout(a.bind(this),0);this.position=g;return}if("Marker"===m.subtype&&(m=m.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===
m[1])h[m[2]|0]=h[m[2]]||{pos:g,count:m[3]|0};else if("END"===m[1]&&this.enableMFiLoop){i=h[m[2]|0];if(0!==i.count){0<i.count&&i.count--;g=i.pos;this.timer=setTimeout(a.bind(this),0);this.position=g;return}h[m[2]|0]=r}e.postMessage(c[g++].webMidiLink,"*")}while(g<j&&c[g].time===b);g<j?this.timer=setTimeout(a.bind(this),this.tempo/(1E3*d)*(c[g].time-b)*(1/this.pitch)):this.enableCC111Loop&&h[0]&&"number"===typeof h[0].pos?(g=h[0].pos,this.timer=setTimeout(a.bind(this),0)):this.enableLoop&&(this.tempo=
5E5,this.position=0,R(this));this.position=g}}var d=b.sequence.timeDivision,c=b.track,e=b.webMidiLink,g=b.position||0,h=[];b.pause?(b.timer=setTimeout(a.bind(b),b.resume),b.pause=s,b.resume=-1):b.timer=setTimeout(a.bind(b),b.tempo/1E3*d*b.track[0].time)}
t.loadMidiFile=function(b){b=new M(b);var a,d,c,e,g,h,f,j;Q(this);e=this.track=[];b.parse();d=b.tracks;a=Array(d.length);c=b.plainTracks;g=0;for(h=d.length;g<h;++g)a[g]=0;g=0;for(h=d.length;g<h;++g){a=d[g];f=0;for(j=a.length;f<j;++f)e.push({track:g,eventId:f,time:a[f].time,event:a[f],webMidiLink:"midi,"+Array.prototype.map.call(c[g][f],function(a){return a.toString(16)}).join(",")})}e.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?
1:a.eventId<b.eventId?-1:0});this.sequence=b};
t.loadMldFile=function(b){function a(a,b){var c=[0,12,-24,-12];if(c[b]!==q)return a+c[b];n(Error("invalid OctaveShift value:"+b))}var d=new F(b),c,e,g,h,f,j;Q(this);b=this.track=[];d.parse();var m={timeDivision:48};e=m.tracks=[];g=m.plainTracks=[];h=d.tracks;var i,k,l,p,w,v,A;j=0;for(w=h.length;j<w;++j){i=h[j];d=g[j]=[];f=[];l=p=v=0;for(A=i.length;v<A;++v)switch(c=i[v],l+=c.deltaTime,c.id=p,c.time=l,c.subType){case "Nop":break;case "Note":f[p++]=c;f[p]={id:p,type:"internal",subType:"NoteOff",time:l+
c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};p++;break;case "InstrumentHighPart":k=c;c=i[++v];"InstrumentLowPart"!==c.subType&&n(Error("broken instrument"));f[p]={id:p,type:"internal",subType:"ProgramChange",time:l,part:c.value.part,instrument:k.value.instrument<<6|c.value.instrument};p++;break;default:f[p++]=c}f.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});e[j]=[];l=v=0;for(A=f.length;v<A;++v){c=f[v];i={time:c.time,deltaTime:c.time-
l};switch(c.subType){case "Note":l=a(c.key+45,c.octaveShift);9===4*j+c.voice&&(l-=10);d.push([144|4*j+c.voice,l,2*c.velocity]);break;case "NoteOff":l=a(c.key+45,c.octaveShift);9===4*j+c.voice&&(l-=10);d.push([128|4*j+c.voice,l,2*c.velocity]);break;case "ProgramChange":d.push([192|4*j+c.part,c.instrument]);i.subtype="ProgramChange";break;case "SetTempo":l=288E7/(c.value.tempo*c.value.timeBase);d.push([255,81,3,l>>16&255,l>>8&255,l&255]);i.subtype="SetTempo";i.data=[l|0];break;case "Loop":l=c.value.count;
l="LOOP_"+(0===c.value.point?"START":"END")+"=ID:"+c.value.id+",COUNT:"+(0===l?-1:l);d.push([255,6,l.length].concat(l.split("").map(function(a){return a.charCodeAt(0)})));i.subtype="Marker";i.data=[l];break;case "MasterVolume":l=c.value;d.push([240,127,127,4,1,l,l,247]);break;case "Modulation":d.push([176|4*j+c.value.part,1,2*c.value.depth]);break;case "Volume":d.push([176|4*j+c.value.part,7,2*c.value.volume]);break;case "Valance":d.push([176|4*j+c.value.part,10,2*(c.value.valance-32)+64]);break;
case "PitchBend":d.push([224|4*j+c.value.part,2*c.value.value,2*c.value.value]);break;case "PitchBendRange":d.push([176|4*j+c.value.part,100,0,176|4*j+c.value.part,101,0,176|4*j+c.value.part,6,2*c.value.value]);break;case "MasterCoarseTuning":d.push([176|4*j+c.value.part,100,0,176|4*j+c.value.part,101,2,176|4*j+c.value.part,6,2*c.value.value]);break;default:continue}e[j].push(i);l=c.time}}e=m.tracks;c=Array(e.length);g=m.plainTracks;d=0;for(h=e.length;d<h;++d)c[d]=0;d=0;for(h=e.length;d<h;++d){c=
e[d];f=0;for(j=c.length;f<j;++f)b.push({track:d,eventId:f,time:c[f].time,event:c[f],webMidiLink:"midi,"+Array.prototype.map.call(g[d][f],function(a){return a.toString(16)}).join(",")})}b.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.sequence=m};
t.loadSoundFont=function(b,a){var d=new I(b),c=this.bank;d.parse();var e=d.presetHeader,g=d.presetZone,h=[],f,j,m,i,k,l,p,w,v,A,O;w=0;for(v=e.length;w<v;++w){f=e[w].presetBagIndex;j=e[w+1]?e[w+1].presetBagIndex:g.length;m=[];for(A=j;f<A;++f){l=[];i=g[f].presetGeneratorIndex;k=g[f+1]?g[f+1].presetGeneratorIndex:d.presetZoneGenerator.length;j={unknown:[]};for(p=k;i<p;++i)l.push(d.presetZoneGenerator[i]),k=d.presetZoneGenerator[i],"unknown"===k.type?j.unknown.push(k.value):("instrument"===k.type&&(O=
k.value.amount),j[k.type]=k.value);k=[];i=g[f].presetModulatorIndex;for(p=g[f+1]?g[f+1].presetModulatorIndex:d.presetZoneModulator.length;i<p;++i)k.push(d.presetZoneModulator[i]);m.push({generator:j,generatorSequence:l,modulator:k})}h.push({name:e[w].presetName,info:m,header:e[w],instrument:O})}var S=d.createInstrument(),L=[],T=this,U=setInterval(function(){var e=h.shift(),f,g;e===q?(clearInterval(U),L.forEach(function(a,b){a!==q&&(c[b]=a)}),a()):(f=S[e.instrument],g=e.header.preset,"EOI"!==f.name.replace(/\0*$/,
"")&&(L[g]=[],f.info.forEach(function(a){a=a.generator;var c,e=d.samplingData,f,h;if(!(a.keyRange===q||a.sampleID===q)){c=d.sampleHeader[a.sampleID.amount];f=a.keyRange.lo;for(h=a.keyRange.hi;f<=h;++f){var i=L[g],l=f,m=T.createInstrument(b,e,c,a,f),j=m.length,k=c.sampleRate,k=[82,73,70,70,j+36&255,j+36>>8&255,j+36>>16&255,j+36>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,k&255,k>>8&255,k>>16&255,k>>24&255,2*k&255,2*k>>8&255,2*k>>16&255,2*k>>24&255,2,0,16,0,100,97,116,97,j&255,j>>8&255,j>>16&
255,j>>24&255],j=new Uint8Array(k.length+j);j.set(k,0);j.set(m,k.length);i[l]=j}}})))},0)};
t.createInstrument=function(b,a,d,c,e){var g=b.subarray(a.offset+2*d.start,a.offset+2*d.startLoop),h=b.subarray(a.offset+2*d.startLoop,a.offset+2*d.endLoop);b=b.subarray(a.offset+2*d.endLoop,a.offset+2*d.end);var f;a=0;d=(4*f*d.sampleRate-g.length-b.length+h.length-1)/h.length|0;0>d&&(d=0);f=Math.pow(Math.pow(2,1/12),e-(c.overridingRootKey?c.overridingRootKey.amount:60));c=new Uint8Array(Math.min(g.length+d*h.length+b.length,1E5));c.set(g,a);a+=g.length;for(g=0;g<d;++g)c.set(h,a),a+=h.length;c.set(b,
a);h=f;f=new Uint8Array(c.length/h|0);g=0;for(e=f.length;g<e;g+=2)b=2*(g/2*h+0.5|0),f[g]=c[b],f[g+1]=c[b+1];return f};x("SMF.Player",P);x("SMF.Player.prototype.play",P.prototype.play);x("SMF.Player.prototype.stop",P.prototype.stop);x("SMF.Player.prototype.loadMidiFile",P.prototype.loadMidiFile);x("SMF.Player.prototype.loadMldFile",P.prototype.loadMldFile);x("SMF.Player.prototype.setLoop",P.prototype.setLoop);x("SMF.Player.prototype.setCC111Loop",P.prototype.setCC111Loop);x("SMF.Player.prototype.setFalcomLoop",P.prototype.setFalcomLoop);x("SMF.Player.prototype.setMFiLoop",P.prototype.setMFiLoop);
x("SMF.Player.prototype.setWebMidiLink",P.prototype.setWebMidiLink);x("SMF.Player.prototype.setPitch",P.prototype.setPitch);}).call(this);
