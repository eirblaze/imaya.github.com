/** @license mid.js 2012 - imaya [ https://github.com/imaya/mid.js ] The MIT License */
(function() {'use strict';function n(b){throw b;}var q=void 0,r=null,s=!1,t=this;function u(b,a){var d=b.split("."),c=t;!(d[0]in c)&&c.execScript&&c.execScript("var "+d[0]);for(var e;d.length&&(e=d.shift());)!d.length&&a!==q?c[e]=a:c=c[e]?c[e]:c[e]={}}function y(b){var a=z;function d(){}d.prototype=a.prototype;b.superClass_=a.prototype;b.prototype=new d;b.prototype.constructor=b};var A=t.Uint8Array!==q&&t.Uint16Array!==q&&t.Uint32Array!==q;function z(b,a,d){this.subtype=b;this.deltaTime=a;this.time=d}function B(b,a,d,c,e,g){z.call(this,b,a,d);this.channel=c;this.parameter1=e;this.parameter2=g}y(B);function C(b,a,d,c){z.call(this,b,a,d);this.data=c}y(C);function D(b,a,d,c){z.call(this,b,a,d);this.data=c}y(D);function E(b,a){a=a||{};this.input=b;this.ip=a.index||0}
E.prototype.parse=function(){var b=this.input,a=this.ip,d=this.header={},c=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"melo"!==c&&n(Error("invalid MFi signature:"+c));d.fileLength=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;d.trackOffset=(b[a++]<<16|b[a++])+a;d.dataMajorType=b[a++];d.dataMinorType=b[a++];d.numberOfTracks=b[a++];this.ip=a;for(var b=this.input,a=this.ip,d=this.dataInformation={},e;a<this.header.trackOffset;)switch(c=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),e=b[a++]<<
8|b[a++],c){case "titl":case "copy":case "vers":case "date":case "prot":d[c]=String.fromCharCode.apply(r,A?b.subarray(a,a+=e):b.slice(a,a+=e));break;case "sorc":d[c]=b[a++];break;case "note":d[c]=b[a++]<<8|b[a++];break;default:d[c]=A?b.subarray(a,a+=e):b.slice(a,a+=e)}this.ip=a;var b=this.input,a=this.ip,g,h,f,d=this.tracks=[],m,c=0;for(e=this.header.numberOfTracks;c<e;++c){g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"trac"!==g&&n(Error("invalid track signature:"+g));g=b[a++]<<24|b[a++]<<16|
b[a++]<<8|b[a++];g=a+g;for(m=d[c]=[];a<g;){f={};f.deltaTime=b[a++];h=b[a++];if(255!==h)f.type="note",f.subType="Note",f.voice=h>>6,f.key=h&63,f.length=b[a++],1===this.dataInformation.note&&(h=b[a++],f.velocity=h>>2,f.octaveShift=h&3);else switch(f.type="meta",h=b[a++],h>>4){case 11:switch(h&15){case 0:f.subType="MasterVolume";f.value=b[a++];break;case 10:f.subType="DrumScale";f.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:n(Error("unknown message type:"+h.toString(16)))}break;case 12:f.subType=
"SetTempo";f.value={timeBase:7===(h&7)?NaN:Math.pow(2,h&7)*(0===(h&8)?6:15),tempo:b[a++]};break;case 13:switch(h&15){case 0:f.subType="Point";f.value=b[a++];break;case 13:f.subType="Loop";f.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:f.subType="Nop";f.value=b[a++];break;case 15:f.subType="EndOfTrack";f.value=b[a++];break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 14:switch(h&15){case 0:f.subType="InstrumentLowPart";f.value={part:b[a]>>6,instrument:b[a++]&
63};break;case 1:f.subType="InstrumentHighPart";f.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:f.subType="Volume";f.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:f.subType="Valance";f.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:f.subType="PitchBend";f.value={part:b[a]>>6,value:b[a++]&63};break;case 5:f.subType="ChannelAssign";f.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:f.subType="VolumeChange";f.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:f.subType=
"PitchBendRange";f.value={part:b[a]>>6,value:b[a++]&63};break;case 9:f.subType="MasterCoarseTuning";f.value={part:b[a]>>6,value:b[a++]&63};break;case 10:f.subType="Modulation";f.value={part:b[a]>>6,depth:b[a++]&63};break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 15:switch(h&15){case 0:f.subType="EditInstrument";h=f;var k=b[a++]<<8|b[a++],k=a+k,i=[],l=q;for(1!==b[a++]&&n(Error("invalid EditInstrument const value:"+b[a-1]));a<k;)l={},l.part=b[a++]>>4&3,l.modulator={ML:b[a]>>
5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},l.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},l.octaveSelect=b[a++]&3,i.push(l);h.value=i;break;case 1:f.subType="Vibrato";h=f;a++;a++;1!==b[a++]&&n(Error("invalid Vibrato const value:"+
b[a-1]));k={part:b[a++]>>5&3,"switch":b[a++]>>6};h.value=k;break;case 15:f.subType="DeviceSpecific";h=f;k=b[a++]<<8|b[a++];k=a+k;17!==b[a++]&&n(Error("invalid DeviceSpecific const value:"+b[a-1]));k={data:A?b.subarray(a,a+=k-a):b.slice(a,a+=k-a)};h.value=k;break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;default:n(Error("unkwnon message type:"+h.toString(16)))}m.push(f)}a=g}this.ip=a};
E.prototype.deltaTimeToByteArray=function(b){for(var a=[];128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a};function F(b,a){a=a||{};this.input=b;this.ip=a.index||0;this.length=a.length||b.length-this.ip;this.offset=this.ip;this.padding=a.padding!==q?a.padding:!0;this.bigEndian=a.bigEndian!==q?a.bigEndian:s}
F.prototype.parse=function(){var b=this.length+this.offset;for(this.chunkList=[];this.ip<b;){var a=this.input,d=this.ip,c=q;this.chunkList.push({type:String.fromCharCode(a[d++],a[d++],a[d++],a[d++]),size:c=this.bigEndian?(a[d++]<<24|a[d++]<<16|a[d++]<<8|a[d++])>>>0:(a[d++]|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,offset:d});d+=c;this.padding&&1===(d-this.offset&1)&&d++;this.ip=d}};function G(b,a){var d=b.chunkList[a];return d===q?r:d};function H(b,a){a=a||{};this.input=b;this.parserOption=a.parserOption}
H.prototype.parse=function(){var b=new F(this.input,this.parserOption);b.parse();1!==b.chunkList.length&&n(Error("wrong chunk length"));b=G(b,0);b===r&&n(Error("chunk not found"));var a=this.input,d=b.offset,c;"RIFF"!==b.type&&n(Error("invalid chunk type:",b.type));c=String.fromCharCode(a[d++],a[d++],a[d++],a[d++]);"sfbk"!==c&&n(Error("invalid signature:",c));b=new F(a,{index:d,length:b.size-4});b.parse();3!==b.chunkList.length&&n(Error("invalid sfbk structure"));a=G(b,0);d=this.input;c=a.offset;
var e;"LIST"!==a.type&&n(Error("invalid chunk type:",a.type));e=String.fromCharCode(d[c++],d[c++],d[c++],d[c++]);"INFO"!==e&&n(Error("invalid signature:",e));(new F(d,{index:c,length:a.size-4})).parse();a=G(b,1);d=this.input;c=a.offset;"LIST"!==a.type&&n(Error("invalid chunk type:",a.type));e=String.fromCharCode(d[c++],d[c++],d[c++],d[c++]);"sdta"!==e&&n(Error("invalid signature:",e));a=new F(d,{index:c,length:a.size-4});a.parse();1!==a.chunkList.length&&n(Error("TODO"));this.samplingData=G(a,0);
b=G(b,2);a=this.input;d=b.offset;"LIST"!==b.type&&n(Error("invalid chunk type:",b.type));c=String.fromCharCode(a[d++],a[d++],a[d++],a[d++]);"pdta"!==c&&n(Error("invalid signature:",c));b=new F(a,{index:d,length:b.size-4});b.parse();9!==b.chunkList.length&&n(Error("invalid pdta chunk"));a=G(b,0);d=this.input;c=a.offset;e=this.presetHeader=[];var g=a.offset+a.size;for("phdr"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({presetName:String.fromCharCode.apply(r,d.subarray(c,c+=20)),preset:d[c++]|
d[c++]<<8,bank:d[c++]|d[c++]<<8,presetBagIndex:d[c++]|d[c++]<<8,library:(d[c++]|d[c++]<<8|d[c++]<<16|d[c++]<<24)>>>0,genre:(d[c++]|d[c++]<<8|d[c++]<<16|d[c++]<<24)>>>0,morphology:(d[c++]|d[c++]<<8|d[c++]<<16|d[c++]<<24)>>>0});a=G(b,1);d=this.input;c=a.offset;e=this.presetZone=[];g=a.offset+a.size;for("pbag"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({presetGeneratorIndex:d[c++]|d[c++]<<8,presetModulatorIndex:d[c++]|d[c++]<<8});a=G(b,2);d=this.input;c=a.offset;e=this.presetZoneModulator=
[];g=a.offset+a.size;for("pmod"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({modulatorSourceOper:d[c++]|d[c++]<<8,modulatorDestinationOper:d[c++]|d[c++]<<8,amount:d[c++]|d[c++]<<8,modulatorAmountSourceOper:d[c++]|d[c++]<<8,modulatorTransformOper:d[c++]|d[c++]<<8});a=G(b,3);"pgen"!==a.type&&n(Error("invalid chunk type:",a.type));this.presetZoneGenerator=I(this,a);a=G(b,4);d=this.input;c=a.offset;e=this.instrument=[];g=a.offset+a.size;for("inst"!==a.type&&n(Error("invalid chunk type:",
a.type));c<g;)e.push({instrumentName:String.fromCharCode.apply(r,d.subarray(c,c+=20)),instrumentBagIndex:d[c++]|d[c++]<<8});a=G(b,5);d=this.input;c=a.offset;e=this.instrumentZone=[];g=a.offset+a.size;for("ibag"!==a.type&&n(Error("invalid chunk type:",a.type));c<g;)e.push({instrumentGeneratorIndex:d[c++]|d[c++]<<8,instrumentModulatorIndex:d[c++]|d[c++]<<8});a=G(b,6);d=this.input;c=a.offset;e=this.instrumentZoneModulator=[];g=a.offset+a.size;for("imod"!==a.type&&n(Error("invalid chunk type:",a.type));c<
g;)e.push({modulatorSourceOper:d[c++]|d[c++]<<8,modulatorDestinationOper:d[c++]|d[c++]<<8,amount:d[c++]|d[c++]<<8,modulatorAmountSourceOper:d[c++]|d[c++]<<8,modulatorTransformOper:d[c++]|d[c++]<<8});a=G(b,7);"igen"!==a.type&&n(Error("invalid chunk type:",a.type));this.instrumentZoneGenerator=I(this,a);b=G(b,8);a=this.input;d=b.offset;c=this.sampleHeader=[];e=b.offset+b.size;for("shdr"!==b.type&&n(Error("invalid chunk type:",b.type));d<e;)c.push({sampleName:String.fromCharCode.apply(r,a.subarray(d,
d+=20)),start:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,end:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,startLoop:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,endLoop:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,sampleRate:(a[d++]<<0|a[d++]<<8|a[d++]<<16|a[d++]<<24)>>>0,originalPitch:a[d++],pitchCorrection:a[d++]<<24>>24,sampleLink:a[d++]|a[d++]<<8,sampleType:a[d++]|a[d++]<<8})};
function I(b,a){for(var d=b.input,c=a.offset,e=a.offset+a.size,g,h,f=[];c<e;)if(g=d[c++]|d[c++]<<8,h=K[g],h===q)f.push({type:h,value:{code:g,amount:d[c]|d[c+1]<<8<<16>>16,lo:d[c++],hi:d[c++]}});else switch(h){case "keyRange":case "velRange":case "keynum":case "velocity":f.push({type:h,value:{lo:d[c++],hi:d[c++]}});break;default:f.push({type:h,value:{amount:d[c++]|d[c++]<<8<<16>>16}})}return f}
H.prototype.createInstrument=function(){var b=this.instrument,a=this.instrumentZone,d=[],c,e,g,h,f,m,k,i,l,j;i=0;for(l=b.length;i<l;++i){c=b[i].instrumentBagIndex;e=b[i+1]?b[i+1].instrumentBagIndex:a.length;g=[];for(j=e;c<j;++c){m=[];h=a[c].instrumentGeneratorIndex;f=a[c+1]?a[c+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length;e={unknown:[]};for(k=f;h<k;++h)m.push(this.instrumentZoneGenerator[h]),f=this.instrumentZoneGenerator[h],"unknown"===f.type?e.unknown.push(f.value):e[f.type]=
f.value;f=[];h=a[c].instrumentModulatorIndex;for(k=a[c+1]?a[c+1].instrumentModulatorIndex:this.instrumentZoneModulator.length;h<k;++h)f.push(this.instrumentZoneModulator[h]);g.push({generator:e,generatorSequence:m,modulator:f})}d.push({name:b[i].instrumentName,info:g})}return d};
var K=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",,"chorusEffectsSend","reverbEffectsSend","pan",,,,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay",
"delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",,"scaleTuning","exclusiveClass","overridingRootKey"];function L(b,a){a=a||{};a.padding=s;a.bigEndian=!0;this.input=b;this.ip=a.index||0;this.chunkIndex=0;this.riffParser_=new F(b,a);this.tracks=[];this.plainTracks=[]}L.prototype.parse=function(){var b,a;this.riffParser_.parse();b=G(this.riffParser_,this.chunkIndex++);a=this.input;var d=b.offset;(!b||"MThd"!==b.type)&&n(Error("invalid header signature"));this.formatType=a[d++]<<8|a[d++];this.numberOfTracks=a[d++]<<8|a[d++];this.timeDivision=a[d++]<<8|a[d++];b=0;for(a=this.numberOfTracks;b<a;++b)N(this)};
function N(b){function a(){var a=0,b;do b=c[e++],a=a<<7|b&127;while(0!==(b&128));return a}var d=G(b.riffParser_,b.chunkIndex++),c=b.input,e=d.offset,g,h,f,m,k,i,l=0,j,p;(!d||"MTrk"!==d.type)&&n(Error("invalid header signature"));for(var d=d.offset+d.size,w=[],v=[];e<d;){g=a();l+=g;j=e;p=c[e++];h=p>>4&15;f=p&15;8>h?(h=m,f=k,p=m<<4|k,e--,j--):(m=h,k=f);var x=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(h){case 8:case 9:case 10:case 11:case 13:case 14:i=
new B(x[h],g,l,f,c[e++],c[e++]);break;case 12:i=new B(x[h],g,l,f,c[e++]);break;case 15:switch(f){case 0:i=a();247!==c[e+i-1]&&n(Error("invalid SysEx event"));i=new C("SystemExclusive",g,l,A?c.subarray(e,(e+=i)-1):c.slice(e,(e+=i)-1));break;case 7:i=a();i=new C("SystemExclusive(F7)",g,l,A?c.subarray(e,e+=i):c.slice(e,e+=i));break;case 15:h=c[e++];i=a();switch(h){case 0:i=new D("SequenceNumber",g,l,[c[e++],c[e++]]);break;case 1:i=new D("TextEvent",g,l,[String.fromCharCode.apply(r,A?c.subarray(e,e+=
i):c.slice(e,e+=i))]);break;case 2:i=new D("CopyrightNotice",g,l,[String.fromCharCode.apply(r,A?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 3:i=new D("SequenceTrackName",g,l,[String.fromCharCode.apply(r,A?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 4:i=new D("InstrumentName",g,l,[String.fromCharCode.apply(r,A?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 5:i=new D("Lyrics",g,l,[String.fromCharCode.apply(r,A?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 6:i=new D("Marker",g,l,[String.fromCharCode.apply(r,
A?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 7:i=new D("CuePoint",g,l,[String.fromCharCode.apply(r,A?c.subarray(e,e+=i):c.slice(e,e+=i))]);break;case 32:i=new D("MidiChannelPrefix",g,l,[c[e++]]);break;case 47:i=new D("EndOfTrack",g,l,[]);break;case 81:i=new D("SetTempo",g,l,[c[e++]<<16|c[e++]<<8|c[e++]]);break;case 84:i=new D("SmpteOffset",g,l,[c[e++],c[e++],c[e++],c[e++],c[e++]]);break;case 88:i=new D("TimeSignature",g,l,[c[e++],c[e++],c[e++],c[e++]]);break;case 89:i=new D("KeySignature",g,
l,[c[e++],c[e++]]);break;case 127:i=new D("SequencerSpecific",g,l,[A?c.subarray(e,e+=i):c.slice(e,e+=i)]);break;default:i=new D("Unknown",g,l,[h,A?c.subarray(e,e+=i):c.slice(e,e+=i)])}break;default:t.console.log("unknown message:",p.toString(16))}break;default:n(Error("invalid status"))}g=e-j;j=A?c.subarray(j,j+g):c.slice(j,j+g);j[0]=p;i instanceof B&&("NoteOn"===i.subtype&&0===i.parameter2)&&(i.subtype=x[8],j=[128|i.channel,i.parameter1,i.parameter2],A&&(j=new Uint8Array(j)));v.push(j);w.push(i)}b.tracks.push(w);
b.plainTracks.push(v)};function O(){this.tempo=5E5;this.ready=s;this.loopCount=this.position=0}O.prototype.stop=function(){var b;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(b=0;16>b;++b)this.webMidiLink.postMessage("midi,b"+b.toString(16)+",78,0","*")};function P(b){b.stop();b.pause=s;b.tempo=5E5;b.loopCount=0;b.track=r;b.resume=-1;b.sequence=r;b.position=0;clearTimeout(b.timer)}
O.prototype.play=function(b){var a;this.webMidiLink||(a=document.createElement("iframe"),a.src=b||"http://www.g200kg.com/en/docs/gmplayer/",a.width=a.height=600,document.body.appendChild(a),this.webMidiLink=a.contentWindow);this.ready?Q(this):window.addEventListener("message",function(a){"link,ready"===a.data&&(this.ready=!0,Q(this))}.bind(this),s)};
function Q(b){function a(){var b=c[g].time,m=c.length,k;if(this.pause)this.resume=Date.now()-this.resume;else{do{k=c[g].event;"SetTempo"===k.subtype&&(this.tempo=k.data[0]);"ControlChange"===k.subtype&&111===k.parameter1&&(h=g);if("Marker"===k.subtype&&("A"===k.data[0]&&(t.console.log("mark:",g),h=g),"B"===k.data[0]&&"number"===typeof h)){t.console.log("mark jump");g=h;this.loopCount++;this.timer=setTimeout(a.bind(this),0);this.position=g;return}e.postMessage(c[g++].webMidiLink,"*")}while(g<m&&c[g].time===
b);g<m?this.timer=setTimeout(a.bind(this),this.tempo/(1E3*d)*(c[g].time-b)):"number"===typeof h&&(g=h,this.loopCount++,this.timer=setTimeout(a.bind(this),0));this.position=g}}var d=b.sequence.timeDivision,c=b.track,e=b.webMidiLink,g=b.position||0,h;b.pause?(b.timer=setTimeout(a.bind(b),b.resume),b.pause=s,b.resume=-1):b.timer=setTimeout(a.bind(b),b.tempo/1E3*d*b.track[0].time)}
O.prototype.loadMidiFile=function(b){b=new L(b);var a,d,c,e,g,h,f,m;P(this);e=this.track=[];b.parse();d=b.tracks;a=this.trackPosition=Array(d.length);c=b.plainTracks;g=0;for(h=d.length;g<h;++g)a[g]=0;g=0;for(h=d.length;g<h;++g){a=d[g];f=0;for(m=a.length;f<m;++f)e.push({track:g,eventId:f,time:a[f].time,event:a[f],webMidiLink:"midi,"+Array.prototype.map.call(c[g][f],function(a){return a.toString(16)}).join(",")})}e.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<
b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.sequence=b};
O.prototype.loadMldFile=function(b){function a(a,b){var c=[0,12,-24,-12];if(c[b]!==q)return a+c[b];n(Error("invalid OctaveShift value:"+b))}var d=new E(b),c,e,g,h,f,m;P(this);b=this.track=[];d.parse();var k={timeDivision:48};e=k.tracks=[];g=k.plainTracks=[];h=d.tracks;var i,l,j,p,w,v,x;m=0;for(w=h.length;m<w;++m){i=h[m];d=g[m]=[];f=[];j=p=v=0;for(x=i.length;v<x;++v)switch(c=i[v],j+=c.deltaTime,c.id=p,c.time=j,c.subType){case "Nop":break;case "Note":f[p++]=c;f[p]={id:p,type:"internal",subType:"NoteOff",
time:j+c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};p++;break;case "InstrumentHighPart":l=c;c=i[++v];"InstrumentLowPart"!==c.subType&&n(Error("broken instrument"));f[p]={id:p,type:"internal",subType:"ProgramChange",time:j,part:c.value.part,instrument:l.value.instrument<<6|c.value.instrument};p++;break;default:f[p++]=c}f.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});e[m]=[];j=v=0;for(x=f.length;v<x;++v){c=f[v];i={time:c.time,
deltaTime:c.time-j};switch(c.subType){case "Note":j=a(c.key+45,c.octaveShift);9===4*m+c.voice&&(j-=10);d.push([144|4*m+c.voice,j,2*c.velocity]);break;case "NoteOff":j=a(c.key+45,c.octaveShift);9===4*m+c.voice&&(j-=10);d.push([128|4*m+c.voice,j,2*c.velocity]);break;case "ProgramChange":d.push([192|4*m+c.part,c.instrument]);i.subtype="ProgramChange";break;case "SetTempo":j=288E7/(c.value.tempo*c.value.timeBase);d.push([255,81,3,j>>16&255,j>>8&255,j&255]);i.subtype="SetTempo";i.data=[j|0];break;case "MasterVolume":j=
c.value;d.push([240,127,127,4,1,j,j,247]);break;case "Modulation":d.push([176|4*m+c.value.part,1,2*c.value.depth]);break;case "Volume":d.push([176|4*m+c.value.part,7,2*c.value.volume]);break;case "Valance":d.push([176|4*m+c.value.part,10,2*(c.value.valance-32)+64]);break;case "PitchBend":d.push([224|4*m+c.value.part,2*c.value.value,2*c.value.value]);break;case "PitchBendRange":d.push([176|4*m+c.value.part,100,0,176|4*m+c.value.part,101,0,176|4*m+c.value.part,6,2*c.value.value]);break;case "MasterCoarseTuning":d.push([176|
4*m+c.value.part,100,0,176|4*m+c.value.part,101,2,176|4*m+c.value.part,6,2*c.value.value]);break;default:continue}e[m].push(i);j=c.time}}e=k.tracks;c=this.trackPosition=Array(e.length);g=k.plainTracks;d=0;for(h=e.length;d<h;++d)c[d]=0;d=0;for(h=e.length;d<h;++d){c=e[d];f=0;for(m=c.length;f<m;++f)b.push({track:d,eventId:f,time:c[f].time,event:c[f],webMidiLink:"midi,"+Array.prototype.map.call(g[d][f],function(a){return a.toString(16)}).join(",")})}b.sort(function(a,b){return a.time>b.time?1:a.time<
b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.sequence=k};
O.prototype.loadSoundFont=function(b,a){var d=new H(b),c=this.bank;d.parse();var e=d.presetHeader,g=d.presetZone,h=[],f,m,k,i,l,j,p,w,v,x,M;w=0;for(v=e.length;w<v;++w){f=e[w].presetBagIndex;m=e[w+1]?e[w+1].presetBagIndex:g.length;k=[];for(x=m;f<x;++f){j=[];i=g[f].presetGeneratorIndex;l=g[f+1]?g[f+1].presetGeneratorIndex:d.presetZoneGenerator.length;m={unknown:[]};for(p=l;i<p;++i)j.push(d.presetZoneGenerator[i]),l=d.presetZoneGenerator[i],"unknown"===l.type?m.unknown.push(l.value):("instrument"===
l.type&&(M=l.value.amount),m[l.type]=l.value);l=[];i=g[f].presetModulatorIndex;for(p=g[f+1]?g[f+1].presetModulatorIndex:d.presetZoneModulator.length;i<p;++i)l.push(d.presetZoneModulator[i]);k.push({generator:m,generatorSequence:j,modulator:l})}h.push({name:e[w].presetName,info:k,header:e[w],instrument:M})}var R=d.createInstrument(),J=[],S=this,T=setInterval(function(){var e=h.shift(),f,g;e===q?(clearInterval(T),J.forEach(function(a,b){a!==q&&(c[b]=a)}),a()):(f=R[e.instrument],g=e.header.preset,"EOI"!==
f.name.replace(/\0*$/,"")&&(J[g]=[],f.info.forEach(function(a){a=a.generator;var c,e=d.samplingData,f,h;if(!(a.keyRange===q||a.sampleID===q)){c=d.sampleHeader[a.sampleID.amount];f=a.keyRange.lo;for(h=a.keyRange.hi;f<=h;++f){var i=J[g],m=f,l=S.createInstrument(b,e,c,a,f),j=l.length,k=c.sampleRate,k=[82,73,70,70,j+36&255,j+36>>8&255,j+36>>16&255,j+36>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,k&255,k>>8&255,k>>16&255,k>>24&255,2*k&255,2*k>>8&255,2*k>>16&255,2*k>>24&255,2,0,16,0,100,97,116,
97,j&255,j>>8&255,j>>16&255,j>>24&255],j=new Uint8Array(k.length+j);j.set(k,0);j.set(l,k.length);i[m]=j}}})))},0)};
O.prototype.createInstrument=function(b,a,d,c,e){var g=b.subarray(a.offset+2*d.start,a.offset+2*d.startLoop),h=b.subarray(a.offset+2*d.startLoop,a.offset+2*d.endLoop);b=b.subarray(a.offset+2*d.endLoop,a.offset+2*d.end);var f;a=0;d=(4*f*d.sampleRate-g.length-b.length+h.length-1)/h.length|0;0>d&&(d=0);f=Math.pow(Math.pow(2,1/12),e-(c.overridingRootKey?c.overridingRootKey.amount:60));c=new Uint8Array(Math.min(g.length+d*h.length+b.length,1E5));c.set(g,a);a+=g.length;for(g=0;g<d;++g)c.set(h,a),a+=h.length;
c.set(b,a);h=f;f=new Uint8Array(c.length/h|0);g=0;for(e=f.length;g<e;g+=2)b=2*(g/2*h+0.5|0),f[g]=c[b],f[g+1]=c[b+1];return f};u("SMF.Player",O);u("SMF.Player.prototype.play",O.prototype.play);u("SMF.Player.prototype.stop",O.prototype.stop);u("SMF.Player.prototype.loadMidiFile",O.prototype.loadMidiFile);}).call(this);
