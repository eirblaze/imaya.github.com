/** @license mid.js 2012 - imaya [ https://github.com/imaya/mid.js ] The MIT License */
(function() {'use strict';function n(b){throw b;}var q=void 0,r=null,s=!1,t=this;function u(b,a){var c=b.split("."),d=t;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)!c.length&&a!==q?d[e]=a:d=d[e]?d[e]:d[e]={}}function x(b){var a=y;function c(){}c.prototype=a.prototype;b.superClass_=a.prototype;b.prototype=new c;b.prototype.constructor=b};var z=t.Uint8Array!==q&&t.Uint16Array!==q&&t.Uint32Array!==q;function y(b,a,c){this.subtype=b;this.deltaTime=a;this.time=c}function B(b,a,c,d,e,f){y.call(this,b,a,c);this.channel=d;this.parameter1=e;this.parameter2=f}x(B);function C(b,a,c,d){y.call(this,b,a,c);this.data=d}x(C);function D(b,a,c,d){y.call(this,b,a,c);this.data=d}x(D);function E(b,a){a=a||{};this.input=b;this.ip=a.index||0}
E.prototype.parse=function(){var b=this.input,a=this.ip,c=this.header={},d=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"melo"!==d&&n(Error("invalid MFi signature:"+d));c.fileLength=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;c.trackOffset=(b[a++]<<16|b[a++])+a;c.dataMajorType=b[a++];c.dataMinorType=b[a++];c.numberOfTracks=b[a++];this.ip=a;for(var b=this.input,a=this.ip,c=this.dataInformation={},e;a<this.header.trackOffset;)switch(d=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),e=b[a++]<<
8|b[a++],d){case "titl":case "copy":case "vers":case "date":case "prot":c[d]=String.fromCharCode.apply(r,z?b.subarray(a,a+=e):b.slice(a,a+=e));break;case "sorc":c[d]=b[a++];break;case "note":c[d]=b[a++]<<8|b[a++];break;default:c[d]=z?b.subarray(a,a+=e):b.slice(a,a+=e)}this.ip=a;var b=this.input,a=this.ip,f,h,g,c=this.tracks=[],m,d=0;for(e=this.header.numberOfTracks;d<e;++d){f=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"trac"!==f&&n(Error("invalid track signature:"+f));f=b[a++]<<24|b[a++]<<16|
b[a++]<<8|b[a++];f=a+f;for(m=c[d]=[];a<f;){g={};g.deltaTime=b[a++];h=b[a++];if(255!==h)g.type="note",g.subType="Note",g.voice=h>>6,g.key=h&63,g.length=b[a++],1===this.dataInformation.note&&(h=b[a++],g.velocity=h>>2,g.octaveShift=h&3);else switch(g.type="meta",h=b[a++],h>>4){case 11:switch(h&15){case 0:g.subType="MasterVolume";g.value=b[a++];break;case 10:g.subType="DrumScale";g.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:n(Error("unknown message type:"+h.toString(16)))}break;case 12:g.subType=
"SetTempo";g.value={timeBase:7===(h&7)?NaN:Math.pow(2,h&15)*(0===(h&8)?6:15),tempo:b[a++]};break;case 13:switch(h&15){case 0:g.subType="Point";g.value=b[a++];break;case 13:g.subType="Loop";g.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:g.subType="Nop";g.value=b[a++];break;case 15:g.subType="EndOfTrack";g.value=b[a++];break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 14:switch(h&15){case 0:g.subType="InstrumentLowPart";g.value={part:b[a]>>6,instrument:b[a++]&
63};break;case 1:g.subType="InstrumentHighPart";g.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:g.subType="Volume";g.value={part:b[a]>>6,volume:b[a++]&63};break;case 3:g.subType="Valance";g.value={part:b[a]>>6,valance:b[a++]&63};break;case 5:g.subType="ChannelAssign";g.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:g.subType="VolumeChange";g.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;case 15:switch(h&15){case 0:g.subType=
"EditInstrument";h=g;var k=b[a++]<<8|b[a++],k=a+k,i=[],j=q;for(1!==b[a++]&&n(Error("invalid EditInstrument const value:"+b[a-1]));a<k;)j={},j.part=b[a++]>>4&3,j.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},j.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&
3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},j.octaveSelect=b[a++]&3,i.push(j);h.value=i;break;case 1:g.subType="Vibrato";h=g;a++;a++;1!==b[a++]&&n(Error("invalid Vibrato const value:"+b[a-1]));k={part:b[a++]>>5&3,"switch":b[a++]>>6};h.value=k;break;case 15:g.subType="DeviceSpecific";h=g;k=b[a++]<<8|b[a++];k=a+k;11!==b[a++]&&n(Error("invalid Vibrato const value:"+b[a-1]));k={data:z?b.subarray(a,a+=k-a):b.slice(a,a+=k-a)};h.value=k;break;default:n(Error("unkwnon message type:"+h.toString(16)))}break;default:n(Error("unkwnon message type:"+
h.toString(16)))}m.push(g)}}this.ip=a};E.prototype.deltaTimeToByteArray=function(b){for(var a=[];128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a};function F(b,a){a=a||{};this.input=b;this.ip=a.index||0;this.length=a.length||b.length-this.ip;this.offset=this.ip;this.padding=a.padding!==q?a.padding:!0;this.bigEndian=a.bigEndian!==q?a.bigEndian:s}
F.prototype.parse=function(){var b=this.length+this.offset;for(this.chunkList=[];this.ip<b;){var a=this.input,c=this.ip,d=q;this.chunkList.push({type:String.fromCharCode(a[c++],a[c++],a[c++],a[c++]),size:d=this.bigEndian?(a[c++]<<24|a[c++]<<16|a[c++]<<8|a[c++])>>>0:(a[c++]|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,offset:c});c+=d;this.padding&&1===(c-this.offset&1)&&c++;this.ip=c}};function G(b,a){var c=b.chunkList[a];return c===q?r:c};function H(b,a){a=a||{};this.input=b;this.parserOption=a.parserOption}
H.prototype.parse=function(){var b=new F(this.input,this.parserOption);b.parse();1!==b.chunkList.length&&n(Error("wrong chunk length"));b=G(b,0);b===r&&n(Error("chunk not found"));var a=this.input,c=b.offset,d;"RIFF"!==b.type&&n(Error("invalid chunk type:",b.type));d=String.fromCharCode(a[c++],a[c++],a[c++],a[c++]);"sfbk"!==d&&n(Error("invalid signature:",d));b=new F(a,{index:c,length:b.size-4});b.parse();3!==b.chunkList.length&&n(Error("invalid sfbk structure"));a=G(b,0);c=this.input;d=a.offset;
var e;"LIST"!==a.type&&n(Error("invalid chunk type:",a.type));e=String.fromCharCode(c[d++],c[d++],c[d++],c[d++]);"INFO"!==e&&n(Error("invalid signature:",e));(new F(c,{index:d,length:a.size-4})).parse();a=G(b,1);c=this.input;d=a.offset;"LIST"!==a.type&&n(Error("invalid chunk type:",a.type));e=String.fromCharCode(c[d++],c[d++],c[d++],c[d++]);"sdta"!==e&&n(Error("invalid signature:",e));a=new F(c,{index:d,length:a.size-4});a.parse();1!==a.chunkList.length&&n(Error("TODO"));this.samplingData=G(a,0);
b=G(b,2);a=this.input;c=b.offset;"LIST"!==b.type&&n(Error("invalid chunk type:",b.type));d=String.fromCharCode(a[c++],a[c++],a[c++],a[c++]);"pdta"!==d&&n(Error("invalid signature:",d));b=new F(a,{index:c,length:b.size-4});b.parse();9!==b.chunkList.length&&n(Error("invalid pdta chunk"));a=G(b,0);c=this.input;d=a.offset;e=this.presetHeader=[];var f=a.offset+a.size;for("phdr"!==a.type&&n(Error("invalid chunk type:",a.type));d<f;)e.push({presetName:String.fromCharCode.apply(r,c.subarray(d,d+=20)),preset:c[d++]|
c[d++]<<8,bank:c[d++]|c[d++]<<8,presetBagIndex:c[d++]|c[d++]<<8,library:(c[d++]|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,genre:(c[d++]|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0,morphology:(c[d++]|c[d++]<<8|c[d++]<<16|c[d++]<<24)>>>0});a=G(b,1);c=this.input;d=a.offset;e=this.presetZone=[];f=a.offset+a.size;for("pbag"!==a.type&&n(Error("invalid chunk type:",a.type));d<f;)e.push({presetGeneratorIndex:c[d++]|c[d++]<<8,presetModulatorIndex:c[d++]|c[d++]<<8});a=G(b,2);c=this.input;d=a.offset;e=this.presetZoneModulator=
[];f=a.offset+a.size;for("pmod"!==a.type&&n(Error("invalid chunk type:",a.type));d<f;)e.push({modulatorSourceOper:c[d++]|c[d++]<<8,modulatorDestinationOper:c[d++]|c[d++]<<8,amount:c[d++]|c[d++]<<8,modulatorAmountSourceOper:c[d++]|c[d++]<<8,modulatorTransformOper:c[d++]|c[d++]<<8});a=G(b,3);"pgen"!==a.type&&n(Error("invalid chunk type:",a.type));this.presetZoneGenerator=I(this,a);a=G(b,4);c=this.input;d=a.offset;e=this.instrument=[];f=a.offset+a.size;for("inst"!==a.type&&n(Error("invalid chunk type:",
a.type));d<f;)e.push({instrumentName:String.fromCharCode.apply(r,c.subarray(d,d+=20)),instrumentBagIndex:c[d++]|c[d++]<<8});a=G(b,5);c=this.input;d=a.offset;e=this.instrumentZone=[];f=a.offset+a.size;for("ibag"!==a.type&&n(Error("invalid chunk type:",a.type));d<f;)e.push({instrumentGeneratorIndex:c[d++]|c[d++]<<8,instrumentModulatorIndex:c[d++]|c[d++]<<8});a=G(b,6);c=this.input;d=a.offset;e=this.instrumentZoneModulator=[];f=a.offset+a.size;for("imod"!==a.type&&n(Error("invalid chunk type:",a.type));d<
f;)e.push({modulatorSourceOper:c[d++]|c[d++]<<8,modulatorDestinationOper:c[d++]|c[d++]<<8,amount:c[d++]|c[d++]<<8,modulatorAmountSourceOper:c[d++]|c[d++]<<8,modulatorTransformOper:c[d++]|c[d++]<<8});a=G(b,7);"igen"!==a.type&&n(Error("invalid chunk type:",a.type));this.instrumentZoneGenerator=I(this,a);b=G(b,8);a=this.input;c=b.offset;d=this.sampleHeader=[];e=b.offset+b.size;for("shdr"!==b.type&&n(Error("invalid chunk type:",b.type));c<e;)d.push({sampleName:String.fromCharCode.apply(r,a.subarray(c,
c+=20)),start:(a[c++]<<0|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,end:(a[c++]<<0|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,startLoop:(a[c++]<<0|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,endLoop:(a[c++]<<0|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,sampleRate:(a[c++]<<0|a[c++]<<8|a[c++]<<16|a[c++]<<24)>>>0,originalPitch:a[c++],pitchCorrection:a[c++]<<24>>24,sampleLink:a[c++]|a[c++]<<8,sampleType:a[c++]|a[c++]<<8})};
function I(b,a){for(var c=b.input,d=a.offset,e=a.offset+a.size,f,h,g=[];d<e;)if(f=c[d++]|c[d++]<<8,h=K[f],h===q)g.push({type:h,value:{code:f,amount:c[d]|c[d+1]<<8<<16>>16,lo:c[d++],hi:c[d++]}});else switch(h){case "keyRange":case "velRange":case "keynum":case "velocity":g.push({type:h,value:{lo:c[d++],hi:c[d++]}});break;default:g.push({type:h,value:{amount:c[d++]|c[d++]<<8<<16>>16}})}return g}
H.prototype.createInstrument=function(){var b=this.instrument,a=this.instrumentZone,c=[],d,e,f,h,g,m,k,i,j,l;i=0;for(j=b.length;i<j;++i){d=b[i].instrumentBagIndex;e=b[i+1]?b[i+1].instrumentBagIndex:a.length;f=[];for(l=e;d<l;++d){m=[];h=a[d].instrumentGeneratorIndex;g=a[d+1]?a[d+1].instrumentGeneratorIndex:this.instrumentZoneGenerator.length;e={unknown:[]};for(k=g;h<k;++h)m.push(this.instrumentZoneGenerator[h]),g=this.instrumentZoneGenerator[h],"unknown"===g.type?e.unknown.push(g.value):e[g.type]=
g.value;g=[];h=a[d].instrumentModulatorIndex;for(k=a[d+1]?a[d+1].instrumentModulatorIndex:this.instrumentZoneModulator.length;h<k;++h)g.push(this.instrumentZoneModulator[h]);f.push({generator:e,generatorSequence:m,modulator:g})}c.push({name:b[i].instrumentName,info:f})}return c};
var K=["startAddrsOffset","endAddrsOffset","startloopAddrsOffset","endloopAddrsOffset","startAddrsCoarseOffset","modLfoToPitch","vibLfoToPitch","modEnvToPitch","initialFilterFc","initialFilterQ","modLfoToFilterFc","modEnvToFilterFc","endAddrsCoarseOffset","modLfoToVolume",,"chorusEffectsSend","reverbEffectsSend","pan",,,,"delayModLFO","freqModLFO","delayVibLFO","freqVibLFO","delayModEnv","attackModEnv","holdModEnv","decayModEnv","sustainModEnv","releaseModEnv","keynumToModEnvHold","keynumToModEnvDecay",
"delayVolEnv","attackVolEnv","holdVolEnv","decayVolEnv","sustainVolEnv","releaseVolEnv","keynumToVolEnvHold","keynumToVolEnvDecay","instrument",,"keyRange","velRange","startloopAddrsCoarseOffset","keynum","velocity","initialAttenuation",,"endloopAddrsCoarseOffset","coarseTune","fineTune","sampleID","sampleModes",,"scaleTuning","exclusiveClass","overridingRootKey"];function L(b,a){a=a||{};a.padding=s;a.bigEndian=!0;this.input=b;this.ip=a.index||0;this.chunkIndex=0;this.riffParser_=new F(b,a);this.tracks=[];this.plainTracks=[]}L.prototype.parse=function(){var b,a;this.riffParser_.parse();b=G(this.riffParser_,this.chunkIndex++);a=this.input;var c=b.offset;(!b||"MThd"!==b.type)&&n(Error("invalid header signature"));this.formatType=a[c++]<<8|a[c++];this.numberOfTracks=a[c++]<<8|a[c++];this.timeDivision=a[c++]<<8|a[c++];b=0;for(a=this.numberOfTracks;b<a;++b)N(this)};
function N(b){function a(){var a=0,b;do b=d[e++],a=a<<7|b&127;while(0!==(b&128));return a}var c=G(b.riffParser_,b.chunkIndex++),d=b.input,e=c.offset,f,h,g,m,k,i,j=0,l,v;(!c||"MTrk"!==c.type)&&n(Error("invalid header signature"));for(var c=c.offset+c.size,p=[],w=[];e<c;){f=a();j+=f;l=e;v=d[e++];h=v>>4&15;g=v&15;8>h?(h=m,g=k,v=m<<4|k,e--,l--):(m=h,k=g);var A=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(h){case 8:case 9:case 10:case 11:case 13:case 14:i=
new B(A[h],f,j,g,d[e++],d[e++]);break;case 12:i=new B(A[h],f,j,g,d[e++]);break;case 15:switch(g){case 0:i=a();247!==d[e+i-1]&&n(Error("invalid SysEx event"));i=new C("SystemExclusive",f,j,z?d.subarray(e,(e+=i)-1):d.slice(e,(e+=i)-1));break;case 7:i=a();i=new C("SystemExclusive(F7)",f,j,z?d.subarray(e,e+=i):d.slice(e,e+=i));break;case 15:h=d[e++];i=a();switch(h){case 0:i=new D("SequenceNumber",f,j,[d[e++],d[e++]]);break;case 1:i=new D("TextEvent",f,j,[String.fromCharCode.apply(r,z?d.subarray(e,e+=
i):d.slice(e,e+=i))]);break;case 2:i=new D("CopyrightNotice",f,j,[String.fromCharCode.apply(r,z?d.subarray(e,e+=i):d.slice(e,e+=i))]);break;case 3:i=new D("SequenceTrackName",f,j,[String.fromCharCode.apply(r,z?d.subarray(e,e+=i):d.slice(e,e+=i))]);break;case 4:i=new D("InstrumentName",f,j,[String.fromCharCode.apply(r,z?d.subarray(e,e+=i):d.slice(e,e+=i))]);break;case 5:i=new D("Lyrics",f,j,[String.fromCharCode.apply(r,z?d.subarray(e,e+=i):d.slice(e,e+=i))]);break;case 6:i=new D("Marker",f,j,[String.fromCharCode.apply(r,
z?d.subarray(e,e+=i):d.slice(e,e+=i))]);break;case 7:i=new D("CuePoint",f,j,[String.fromCharCode.apply(r,z?d.subarray(e,e+=i):d.slice(e,e+=i))]);break;case 32:i=new D("MidiChannelPrefix",f,j,[d[e++]]);break;case 47:i=new D("EndOfTrack",f,j,[]);break;case 81:i=new D("SetTempo",f,j,[d[e++]<<16|d[e++]<<8|d[e++]]);break;case 84:i=new D("SmpteOffset",f,j,[d[e++],d[e++],d[e++],d[e++],d[e++]]);break;case 88:i=new D("TimeSignature",f,j,[d[e++],d[e++],d[e++],d[e++]]);break;case 89:i=new D("KeySignature",f,
j,[d[e++],d[e++]]);break;case 127:i=new D("SequencerSpecific",f,j,[z?d.subarray(e,e+=i):d.slice(e,e+=i)]);break;default:i=new D("Unknown",f,j,[h,z?d.subarray(e,e+=i):d.slice(e,e+=i)])}break;default:t.console.log("unknown message:",v.toString(16))}break;default:n(Error("invalid status"))}f=e-l;l=z?d.subarray(l,l+f):d.slice(l,l+f);l[0]=v;i instanceof B&&("NoteOn"===i.subtype&&0===i.parameter2)&&(i.subtype=A[8],l=[128|i.channel,i.parameter1,i.parameter2],z&&(l=new Uint8Array(l)));w.push(l);p.push(i)}b.tracks.push(p);
b.plainTracks.push(w)};function O(){this.tempo=5E5;this.ready=s;this.loopCount=this.position=0}O.prototype.stop=function(){var b;this.pause=!0;this.resume=Date.now();if(this.webMidiLink)for(b=0;16>b;++b)this.webMidiLink.postMessage("midi,b"+b.toString(16)+",78,0","*")};function P(b){b.stop();b.pause=s;b.tempo=5E5;b.loopCount=0;b.track=r;b.resume=-1;b.sequence=r;b.position=0;clearTimeout(b.timer)}
O.prototype.play=function(){var b;this.webMidiLink||(b=document.createElement("iframe"),b.src="http://www.g200kg.com/en/docs/gmplayer/",b.width=b.height=600,document.body.appendChild(b),this.webMidiLink=b.contentWindow);this.ready?Q(this):window.addEventListener("message",function(a){"link,ready"===a.data&&(this.ready=!0,Q(this))}.bind(this),s)};
function Q(b){function a(){var b=d[f].time,m=d.length,k;if(this.pause)this.resume=Date.now()-this.resume;else{do{k=d[f].event;"SetTempo"===k.subtype&&(this.tempo=k.data[0]);"ControlChange"===k.subtype&&111===k.parameter1&&(h=f);if("Marker"===k.subtype&&("A"===k.data[0]&&(h=f),"B"===k.data[0]&&"number"===typeof h)){f=h;this.loopCount++;this.timer=setTimeout(a.bind(this),0);this.position=f;return}e.postMessage(d[f++].webMidiLink,"*")}while(f<m&&d[f].time===b);f<m?this.timer=setTimeout(a.bind(this),
this.tempo/(1E3*c)*(d[f].time-b)):"number"===typeof h&&(f=h,this.loopCount++,this.timer=setTimeout(a.bind(this),0));this.position=f}}var c=b.sequence.timeDivision,d=b.track,e=b.webMidiLink;b.pause?(b.timer=setTimeout(a.bind(b),b.resume),b.pause=s,b.resume=-1):b.timer=setTimeout(a.bind(b),b.tempo/1E3*c*b.track[0].time);var f=b.position||0,h}
O.prototype.loadMidiFile=function(b){b=new L(b);var a,c,d,e,f,h,g,m;P(this);m=this.track=[];b.parse();c=b.tracks;a=this.trackPosition=Array(c.length);d=b.plainTracks;e=0;for(f=c.length;e<f;++e)a[e]=0;e=0;for(f=c.length;e<f;++e){a=c[e];h=0;for(g=a.length;h<g;++h)m.push({track:e,eventId:h,time:a[h].time,event:a[h],webMidiLink:"midi,"+Array.prototype.map.call(d[e][h],function(a){return a.toString(16)}).join(",")})}m.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<
b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.sequence=b};
O.prototype.loadMldFile=function(b){var a=new E(b),c,d,e,f,h,g;P(this);b=this.track=[];a.parse();var m={timeDivision:48};d=m.tracks=[];e=m.plainTracks=[];f=a.tracks;var k,i,j,l,v,p,w;g=0;for(v=f.length;g<v;++g){k=f[g];a=e[g]=[];h=[];j=l=p=0;for(w=k.length;p<w;++p)switch(c=k[p],j+=c.deltaTime,c.id=l,c.time=j,c.subType){case "Note":h[l++]=c;h[l]={id:l,type:"internal",subType:"NoteOff",time:j+c.length,key:c.key,voice:c.voice,velocity:c.velocity,octaveShift:c.octaveShift};l++;break;case "InstrumentHighPart":i=
c;c=k[++p];"InstrumentLowPart"!==c.subType&&n(Error("broken instrument"));h[l]={id:l,type:"internal",subType:"ProgramChange",time:j,instrument:i.value.instrument<<6|c.value.instrument};l++;break;default:h[l++]=c}h.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});d[g]=[];j=p=0;for(w=h.length;p<w;++p){c=h[p];k={time:c.time,deltaTime:c.time-j};switch(c.subType){case "ProgramChange":a.push([192|g,c.instrument]);k.subtype="ProgramChange";break;case "Note":j=c.key+
45;a.push([144|g,j,2*c.velocity]);break;case "NoteOff":j=c.key+45;a.push([128|g,j,2*c.velocity]);break;case "SetTempo":j=288E7/(c.value.tempo*c.value.timeBase);a.push([255,81,3,j>>16&255,j>>8&255,j&255]);k.subtype="SetTempo";k.data=[j|0];break;default:continue}d[g].push(k);j=c.time}}d=m.tracks;c=this.trackPosition=Array(d.length);e=m.plainTracks;a=0;for(f=d.length;a<f;++a)c[a]=0;a=0;for(f=d.length;a<f;++a){c=d[a];h=0;for(g=c.length;h<g;++h)b.push({track:a,eventId:h,time:c[h].time,event:c[h],webMidiLink:"midi,"+
Array.prototype.map.call(e[a][h],function(a){return a.toString(16)}).join(",")})}b.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.sequence=m};
O.prototype.loadSoundFont=function(b,a){var c=new H(b),d=this.bank;c.parse();var e=c.presetHeader,f=c.presetZone,h=[],g,m,k,i,j,l,v,p,w,A,M;p=0;for(w=e.length;p<w;++p){g=e[p].presetBagIndex;m=e[p+1]?e[p+1].presetBagIndex:f.length;k=[];for(A=m;g<A;++g){l=[];i=f[g].presetGeneratorIndex;j=f[g+1]?f[g+1].presetGeneratorIndex:c.presetZoneGenerator.length;m={unknown:[]};for(v=j;i<v;++i)l.push(c.presetZoneGenerator[i]),j=c.presetZoneGenerator[i],"unknown"===j.type?m.unknown.push(j.value):("instrument"===
j.type&&(M=j.value.amount),m[j.type]=j.value);j=[];i=f[g].presetModulatorIndex;for(v=f[g+1]?f[g+1].presetModulatorIndex:c.presetZoneModulator.length;i<v;++i)j.push(c.presetZoneModulator[i]);k.push({generator:m,generatorSequence:l,modulator:j})}h.push({name:e[p].presetName,info:k,header:e[p],instrument:M})}var R=c.createInstrument(),J=[],S=this,T=setInterval(function(){var e=h.shift();if(e===q)clearInterval(T),J.forEach(function(a,b){a!==q&&(d[b]=a)}),a();else{var f=R[e.instrument],g=e.header.preset;
"EOI"!==f.name.replace(/\0*$/,"")&&(J[g]=[],f.info.forEach(function(a){a=a.generator;var d,e=c.samplingData,f,h;if(!(a.keyRange===q||a.sampleID===q)){d=c.sampleHeader[a.sampleID.amount];f=a.keyRange.lo;for(h=a.keyRange.hi;f<=h;++f){var i=J[g],j=f,k=S.createInstrument(b,e,d,a,f),l=k.length,m=d.sampleRate,m=[82,73,70,70,l+36&255,l+36>>8&255,l+36>>16&255,l+36>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,1,0,m&255,m>>8&255,m>>16&255,m>>24&255,2*m&255,2*m>>8&255,2*m>>16&255,2*m>>24&255,2,0,16,0,100,
97,116,97,l&255,l>>8&255,l>>16&255,l>>24&255],l=new Uint8Array(m.length+l);l.set(m,0);l.set(k,m.length);i[j]=l}}}))}},0)};
O.prototype.createInstrument=function(b,a,c,d,e){var f=b.subarray(a.offset+2*c.start,a.offset+2*c.startLoop),h=b.subarray(a.offset+2*c.startLoop,a.offset+2*c.endLoop);b=b.subarray(a.offset+2*c.endLoop,a.offset+2*c.end);var g;a=0;c=(4*g*c.sampleRate-f.length-b.length+h.length-1)/h.length|0;0>c&&(c=0);g=Math.pow(Math.pow(2,1/12),e-(d.overridingRootKey?d.overridingRootKey.amount:60));d=new Uint8Array(Math.min(f.length+c*h.length+b.length,1E5));d.set(f,a);a+=f.length;for(f=0;f<c;++f)d.set(h,a),a+=h.length;
d.set(b,a);h=g;g=new Uint8Array(d.length/h|0);f=0;for(e=g.length;f<e;f+=2)b=2*(f/2*h+0.5|0),g[f]=d[b],g[f+1]=d[b+1];return g};u("SMF.Player",O);u("SMF.Player.prototype.play",O.prototype.play);u("SMF.Player.prototype.stop",O.prototype.stop);u("SMF.Player.prototype.loadMidiFile",O.prototype.loadMidiFile);}).call(this);
