/** @license mid.js 2012 - imaya [ https://github.com/imaya/mid.js ] The MIT License */
(function() {'use strict';function p(b){throw b;}var q=void 0,r=null,s=!1;function t(b){return function(a){this[b]=a}}var u,v=this;function w(b,a){var e=b.split("."),g=v;!(e[0]in g)&&g.execScript&&g.execScript("var "+e[0]);for(var c;e.length&&(c=e.shift());)!e.length&&a!==q?g[c]=a:g=g[c]?g[c]:g[c]={}}function y(b){var a=z;function e(){}e.prototype=a.prototype;b.Q=a.prototype;b.prototype=new e};var B=v.Uint8Array!==q&&v.Uint16Array!==q&&v.Uint32Array!==q;function z(b,a,e){this.f=b;this.time=e}function C(b,a,e,g,c,i){this.f=b;this.time=e;this.b=g;this.v=c;this.a=i}y(C);function D(b,a,e,g){this.f=b;this.time=e;this.data=g}y(D);function E(b,a,e,g){this.f=b;this.time=e;this.data=g}y(E);function F(b,a){a=a||{};this.c=b;this.a=a.index||0}
F.prototype.parse=function(){var b=this.c,a=this.a,e=this.e={},g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"melo"!==g&&p(Error("invalid MFi signature:"+g));e.P=(b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++])>>>0;e.M=(b[a++]<<16|b[a++])+a;e.N=b[a++];e.O=b[a++];e.j=b[a++];this.a=a;for(var b=this.c,a=this.a,e=this.d={},c;a<this.e.M;)switch(g=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]),c=b[a++]<<8|b[a++],g){case "titl":case "copy":case "vers":case "date":case "prot":e[g]=String.fromCharCode.apply(r,
B?b.subarray(a,a+=c):b.slice(a,a+=c));break;case "sorc":e[g]=b[a++];break;case "note":e[g]=b[a++]<<8|b[a++];break;default:e[g]=B?b.subarray(a,a+=c):b.slice(a,a+=c)}this.a=a;var b=this.c,a=this.a,i,d,f,e=this.b=[],l,g=0;for(c=this.e.j;g<c;++g){i=String.fromCharCode(b[a++],b[a++],b[a++],b[a++]);"trac"!==i&&p(Error("invalid track signature:"+i));i=b[a++]<<24|b[a++]<<16|b[a++]<<8|b[a++];i=a+i;for(l=e[g]=[];a<i;){f={};f.deltaTime=b[a++];d=b[a++];if(255!==d)f.type="note",f.subType="Note",f.voice=d>>6,f.key=
d&63,f.length=b[a++],1===this.d.note&&(d=b[a++],f.velocity=d>>2,f.octaveShift=d&3);else switch(f.type="meta",d=b[a++],d>>4){case 11:switch(d&15){case 0:f.subType="MasterVolume";f.value=b[a++];break;case 10:f.subType="DrumScale";f.value={channel:b[a]>>3&7,drum:b[a++]&1};break;default:p(Error("unknown message type:"+d.toString(16)))}break;case 12:f.subType="SetTempo";f.value={timeBase:7===(d&7)?NaN:Math.pow(2,d&7)*(0===(d&8)?6:15),tempo:b[a++]};break;case 13:switch(d&15){case 0:f.subType="Point";f.value=
b[a++];break;case 13:f.subType="Loop";f.value={id:b[a]>>6,count:b[a]>>2&15,point:b[a++]&3};break;case 14:f.subType="Nop";f.value=b[a++];break;case 15:f.subType="EndOfTrack";f.value=b[a++];break;default:p(Error("unkwnon message type:"+d.toString(16)))}break;case 14:switch(d&15){case 0:f.subType="InstrumentLowPart";f.value={part:b[a]>>6,instrument:b[a++]&63};break;case 1:f.subType="InstrumentHighPart";f.value={part:b[a]>>6,instrument:b[a++]&1};break;case 2:f.subType="Volume";f.value={part:b[a]>>6,volume:b[a++]&
63};break;case 3:f.subType="Valance";f.value={part:b[a]>>6,valance:b[a++]&63};break;case 4:f.subType="PitchBend";f.value={part:b[a]>>6,value:b[a++]&63};break;case 5:f.subType="ChannelAssign";f.value={part:b[a]>>6,channel:b[a++]&63};break;case 6:f.subType="VolumeChange";f.value={part:b[a]>>6,volume:(b[a++]&63)<<26>>26};break;case 7:f.subType="PitchBendRange";f.value={part:b[a]>>6,value:b[a++]&63};break;case 9:f.subType="MasterCoarseTuning";f.value={part:b[a]>>6,value:b[a++]&63};break;case 10:f.subType=
"Modulation";f.value={part:b[a]>>6,depth:b[a++]&63};break;default:p(Error("unkwnon message type:"+d.toString(16)))}break;case 15:switch(d&15){case 0:f.subType="EditInstrument";d=f;var k=b[a++]<<8|b[a++],k=a+k,h=[],j=q;for(1!==b[a++]&&p(Error("invalid EditInstrument const value:"+b[a-1]));a<k;)j={},j.part=b[a++]>>4&3,j.modulator={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&
7},j.carrier={ML:b[a]>>5,VIV:b[a]>>4&1,EG:b[a]>>3&1,SUS:b[a]>>2&1,RR:(b[a++]&3)<<2|b[a]>>6,DR:b[a]>>4&15,AR:(b[a++]&3)<<2|b[a]>>6,SL:b[a]>>4&15,TL:(b[a++]&3)<<4|b[a]>>4,WF:b[a]>>3&1,FB:b[a++]&7},j.octaveSelect=b[a++]&3,h.push(j);d.value=h;break;case 1:f.subType="Vibrato";d=f;a++;a++;1!==b[a++]&&p(Error("invalid Vibrato const value:"+b[a-1]));k={part:b[a++]>>5&3,"switch":b[a++]>>6};d.value=k;break;case 15:f.subType="DeviceSpecific";d=f;k=b[a++]<<8|b[a++];k=a+k;17!==b[a++]&&p(Error("invalid DeviceSpecific const value:"+
b[a-1]));k={data:B?b.subarray(a,a+=k-a):b.slice(a,a+=k-a)};d.value=k;break;default:p(Error("unkwnon message type:"+d.toString(16)))}break;default:p(Error("unkwnon message type:"+d.toString(16)))}l.push(f)}a=i}this.a=a};
function G(b){function a(a,b){var c=[0,12,-24,-12];if(c[b]!==q)return a+c[b];p(Error("invalid OctaveShift value:"+b))}var e={timeDivision:48},g=e.tracks=[],e=e.plainTracks=[],c=b.b,i,d,f,l,k,h,j,m,x,A,n=[];for(j=0;16>j;++j)e[j]=[],n[j]=0;j=0;for(m=c.length;j<m;++j){i=c[j];l=[];k=h=x=0;for(A=i.length;x<A;++x)switch(d=i[x],k+=d.deltaTime,d.id=h,d.time=k,d.subType){case "Nop":break;case "Note":l[h++]=d;l[h]={id:h,type:"internal",subType:"NoteOff",time:k+d.length,key:d.key,voice:d.voice,velocity:d.velocity,
octaveShift:d.octaveShift};h++;break;case "InstrumentHighPart":f=d;d=i[++x];"InstrumentLowPart"!==d.subType&&p(Error("broken instrument"));l[h]={id:h,type:"internal",subType:"ProgramChange",time:k,part:d.value.part,instrument:f.value.instrument<<6|d.value.instrument};h++;break;default:l[h++]=d}l.sort(function(a,b){return a.time>b.time?1:a.time<b.time?-1:a.id>b.id?1:a.id<b.id?-1:0});g[j]=[];k=x=0;for(A=l.length;x<A;++x){d=l[x];k=d.time;switch(d.subType){case "Note":f=a(d.key+45,d.octaveShift);i=4*
j+d.voice;9===i&&(f-=10);e[i].push(H(k-n[i]).concat(144|i,f,2*d.velocity));break;case "NoteOff":f=a(d.key+45,d.octaveShift);i=4*j+d.voice;9===i&&(f-=10);e[i].push(H(k-n[i]).concat(128|i,f,2*d.velocity));break;case "ProgramChange":i=4*j+d.part;e[i].push(H(k-n[i]).concat(192|i,d.instrument));break;case "SetTempo":f=288E7/(d.value.tempo*d.value.timeBase);i=0;e[i].push(H(k-n[i]).concat(255,81,3,f>>16&255,f>>8&255,f&255));break;case "Loop":f=d.value.count;f="LOOP_"+(0===d.value.point?"START":"END")+"=ID:"+
d.value.id+",COUNT:"+(0===f?-1:f);i=0;e[i].push(H(k-n[i]).concat([255,6,f.length],f.split("").map(function(a){return a.charCodeAt(0)})));break;case "MasterVolume":f=d.value;i=0;e[i].push(H(k-n[i]).concat(240,7,127,127,4,1,f,f,247));break;case "Modulation":i=4*j+d.value.part;e[i].push(H(k-n[i]).concat(176|i,1,2*d.value.depth));break;case "Volume":i=4*j+d.value.part;e[i].push(H(k-n[i]).concat(176|i,7,2*d.value.volume));break;case "Valance":i=4*j+d.value.part;e[i].push(H(k-n[i]).concat(176|i,10,2*(d.value.valance-
32)+64));break;case "PitchBend":i=4*j+d.value.part;e[i].push(H(k-n[i]).concat(224|i,2*d.value.value,2*d.value.value));break;case "PitchBendRange":i=4*j+d.value.part;e[i].push(H(k-n[i]).concat(176|i,100,0),[0,176|i,101,0],[0,176|i,6,2*d.value.value]);break;case "MasterCoarseTuning":i=4*j+d.value.part;e[i].push(H(k-n[i]).concat(176|i,100,0),[0,176|i,101,2],[0,176|i,6,2*d.value.value]);break;default:continue}n[i]=d.time}}g=[77,84,104,100,0,0,0,6,0,1,0,16,0,48];if(b.d.copy!==q){b=b.d.copy;d=b.length;
l=Array(d);for(c=0;c<d;++c)l[c]=b.charCodeAt(c);c=l;b=c.length;c=[0,255,2].concat(H(b),c);e[0].unshift(c)}d=0;for(b=e.length;d<b;++d){j=e[d];c=[];l=0;for(k=j.length;l<k;++l)Array.prototype.push.apply(c,j[l]);k=c.length;l=[77,84,114,107,k>>24&255,k>>16&255,k>>8&255,k&255];g=g.concat(l,c)}B&&(g=new Uint8Array(g));return g}function H(b){for(var a=[];128<=b;)a.unshift(b&127|(0===a.length?0:128)),b>>>=7;a.unshift(b|(0===a.length?0:128));return a};function I(b,a){a=a||{};this.c=b;this.a=a.index||0;this.length=a.length||b.length-this.a;this.offset=this.a;this.d=a.padding!==q?a.padding:!0;this.e=a.bigEndian!==q?a.bigEndian:s}
I.prototype.parse=function(){var b=this.length+this.offset;for(this.b=[];this.a<b;){var a=this.c,e=this.a,g=q;this.b.push({type:String.fromCharCode(a[e++],a[e++],a[e++],a[e++]),size:g=this.e?(a[e++]<<24|a[e++]<<16|a[e++]<<8|a[e++])>>>0:(a[e++]|a[e++]<<8|a[e++]<<16|a[e++]<<24)>>>0,offset:e});e+=g;this.d&&1===(e-this.offset&1)&&e++;this.a=e}};function J(b,a){var e=b.b[a];return e===q?r:e};function K(b,a){a=a||{};a.padding=s;a.bigEndian=!0;this.c=b;this.d=0;this.a=new I(b,a);this.b=[];this.e=[]}K.prototype.parse=function(){var b,a;this.a.parse();b=J(this.a,this.d++);a=this.c;var e=b.offset;(!b||"MThd"!==b.type)&&p(Error("invalid header signature"));this.g=a[e++]<<8|a[e++];this.j=a[e++]<<8|a[e++];this.L=a[e++]<<8|a[e++];b=0;for(a=this.j;b<a;++b)L(this)};
function L(b){function a(){var a=0,b;do b=g[c++],a=a<<7|b&127;while(0!==(b&128));return a}var e=J(b.a,b.d++),g=b.c,c=e.offset,i,d,f,l,k,h,j=0,m;(!e||"MTrk"!==e.type)&&p(Error("invalid header signature"));for(var e=e.offset+e.size,x=[],A=[];c<e;){i=a();j+=i;m=c;i=g[c++];d=i>>4&15;f=i&15;8>d?(d=l,f=k,i=l<<4|k,c--,m--):(l=d,k=f);var n=[,,,,,,,,"NoteOff","NoteOn","NoteAftertouch","ControlChange","ProgramChange","ChannelAftertouch","PitchBend"];switch(d){case 8:case 9:case 10:case 11:case 13:case 14:h=
new C(n[d],0,j,f,g[c++],g[c++]);break;case 12:h=new C(n[d],0,j,f,g[c++]);break;case 15:switch(f){case 0:h=a();247!==g[c+h-1]&&p(Error("invalid SysEx event"));h=new D("SystemExclusive",0,j,B?g.subarray(c,(c+=h)-1):g.slice(c,(c+=h)-1));break;case 7:h=a();h=new D("SystemExclusive(F7)",0,j,B?g.subarray(c,c+=h):g.slice(c,c+=h));break;case 15:d=g[c++];h=a();switch(d){case 0:h=new E("SequenceNumber",0,j,[g[c++],g[c++]]);break;case 1:h=new E("TextEvent",0,j,[String.fromCharCode.apply(r,B?g.subarray(c,c+=
h):g.slice(c,c+=h))]);break;case 2:h=new E("CopyrightNotice",0,j,[String.fromCharCode.apply(r,B?g.subarray(c,c+=h):g.slice(c,c+=h))]);break;case 3:h=new E("SequenceTrackName",0,j,[String.fromCharCode.apply(r,B?g.subarray(c,c+=h):g.slice(c,c+=h))]);break;case 4:h=new E("InstrumentName",0,j,[String.fromCharCode.apply(r,B?g.subarray(c,c+=h):g.slice(c,c+=h))]);break;case 5:h=new E("Lyrics",0,j,[String.fromCharCode.apply(r,B?g.subarray(c,c+=h):g.slice(c,c+=h))]);break;case 6:h=new E("Marker",0,j,[String.fromCharCode.apply(r,
B?g.subarray(c,c+=h):g.slice(c,c+=h))]);break;case 7:h=new E("CuePoint",0,j,[String.fromCharCode.apply(r,B?g.subarray(c,c+=h):g.slice(c,c+=h))]);break;case 32:h=new E("MidiChannelPrefix",0,j,[g[c++]]);break;case 47:h=new E("EndOfTrack",0,j,[]);break;case 81:h=new E("SetTempo",0,j,[g[c++]<<16|g[c++]<<8|g[c++]]);break;case 84:h=new E("SmpteOffset",0,j,[g[c++],g[c++],g[c++],g[c++],g[c++]]);break;case 88:h=new E("TimeSignature",0,j,[g[c++],g[c++],g[c++],g[c++]]);break;case 89:h=new E("KeySignature",0,
j,[g[c++],g[c++]]);break;case 127:h=new E("SequencerSpecific",0,j,[B?g.subarray(c,c+=h):g.slice(c,c+=h)]);break;default:h=new E("Unknown",0,j,[d,B?g.subarray(c,c+=h):g.slice(c,c+=h)])}break;default:v.console.log("unknown message:",i.toString(16))}break;default:p(Error("invalid status"))}d=c-m;m=B?g.subarray(m,m+d):g.slice(m,m+d);m[0]=i;h instanceof C&&("NoteOn"===h.f&&0===h.a)&&(h.f=n[8],m=[128|h.b,h.v,h.a],B&&(m=new Uint8Array(m)));A.push(m);x.push(h)}b.b.push(x);b.e.push(A)};function M(){this.e=5E5;this.i=s;this.b=0;this.o=this.p=this.l=this.n=s;this.u=1;this.r=16383}u=M.prototype;u.F=t("n");u.G=t("l");u.I=t("p");u.H=t("o");u.k=function(){var b,a;this.h=!0;this.d=Date.now();if(this.a){b=this.a.contentWindow;for(a=0;16>a;++a)b.postMessage("midi,b"+a.toString(16)+",78,0","*")}};u.C=function(){return this.a};
function N(b){b.k();b.e=5E5;b.b=0;b.h=s;b.g=r;b.d=-1;b.s=r;b.t=r;b.m=r;clearTimeout(b.c);b.i?O(b):window.addEventListener("message",function(a){"link,ready"===a.data&&O(b)},s)}u.z=function(){var b=this;this.a||p(Error("WebMidiLink not found"));this.i?(this.g instanceof Array&&this.b>=this.g.length&&(this.b=0),P(this)):window.addEventListener("message",function(a){"link,ready"===a.data&&(b.i=!0,P(b))},s)};
function O(b){b=b.a.contentWindow;var a;for(a=0;16>a;++a)b.postMessage("midi,b"+a.toString(16)+",07,64","*"),b.postMessage("midi,b"+a.toString(16)+",0a,40","*"),b.postMessage("midi,e"+a.toString(16)+",00,40","*"),b.postMessage("midi,b"+a.toString(16)+",64,00","*"),b.postMessage("midi,b"+a.toString(16)+",65,00","*"),b.postMessage("midi,b"+a.toString(16)+",06,02","*"),b.postMessage("midi,b"+a.toString(16)+",26,00","*")}
u.K=function(b){var a=this,e;this.a&&(document.body.removeChild(this.a),this.a=r);e=this.a=document.createElement("iframe");e.src=b||"http://www.g200kg.com/en/docs/gmplayer/";document.body.appendChild(e);window.addEventListener("message",function(b){"link,ready"===b.data&&(a.i=!0,a.w(a.r))},s)};u.w=function(b){var a;this.r=b;this.a&&(a=this.a.contentWindow,a.postMessage("midi,f0,7f,7f,04,01,"+[("0"+(b&127).toString(16)).substr(-2),("0"+(b>>7&127).toString(16)).substr(-2),"7f"].join(),"*"))};u.J=t("u");
function P(b){function a(){var b=c[d].time,k=c.length,h,j,m=Date.now();if(e.h)e.d=Date.now()-e.d;else{do{h=c[d].event;"SetTempo"===h.f&&(e.e=h.data[0]);"ControlChange"===h.f&&111===h.v&&(f[0]={pos:d});if("Marker"===h.f&&("A"===h.data[0]&&(f[0]={pos:d}),"B"===h.data[0]&&this.l&&f[0]&&"number"===typeof f[0].pos)){d=f[0].pos;e.c=setTimeout(a,0);e.b=d;return}if("Marker"===h.f&&(h=h.data[0].match(/^LOOP_(START|END)=ID:(\d+),COUNT:(-?\d+)$/)))if("START"===h[1])f[h[2]|0]=f[h[2]]||{pos:d,count:h[3]|0};else if("END"===
h[1]&&e.p){j=f[h[2]|0];if(0!==j.count){0<j.count&&j.count--;d=j.pos;e.c=setTimeout(a,0);e.b=d;return}f[h[2]|0]=r}i.postMessage(c[d++].webMidiLink,"*")}while(d<k&&c[d].time===b);d<k?(m=Date.now()-m,e.c=setTimeout(a,e.e/(1E3*g)*(c[d].time-b-m)*(1/e.u))):e.n&&f[0]&&"number"===typeof f[0].pos?(d=f[0].pos,e.c=setTimeout(a,0)):e.o&&(b=e,b.e=5E5,b.b=0,P(e));e.b=d}}var e=b,g=b.s.L,c=b.g,i=b.a.contentWindow,d=b.b||0,f=[];b.h?(b.c=setTimeout(a,b.d),b.h=s,b.d=-1):b.c=setTimeout(a,b.e/1E3*g*b.g[0].time)}
u.q=function(b){b=new K(b);N(this);b.parse();var a=this.g=[],e,g,c,i=this.m=[],d,f,l,k;g=b.b;e=Array(g.length);c=b.e;d=0;for(f=g.length;d<f;++d)e[d]=0;d=0;for(f=g.length;d<f;++d){e=g[d];l=0;for(k=e.length;l<k;++l)0===b.g&&"SequenceTrackName"===e[l].f&&(this.t=e[l].data[0]),"CopyrightNotice"===e[l].f&&i.push(e[l].data[0]),a.push({track:d,eventId:l,time:e[l].time,event:e[l],webMidiLink:"midi,"+Array.prototype.map.call(c[d][l],function(a){return a.toString(16)}).join(",")})}a.sort(function(a,b){return a.time>
b.time?1:a.time<b.time?-1:a.track>b.track?1:a.track<b.track?-1:a.eventId>b.eventId?1:a.eventId<b.eventId?-1:0});this.s=b};u.D=function(b){b=new F(b);N(this);b.parse();this.q(G(b))};u.B=function(){return this.t};u.A=function(){return this.m};w("SMF.Player",M);w("SMF.Player.prototype.play",M.prototype.z);w("SMF.Player.prototype.stop",M.prototype.k);w("SMF.Player.prototype.loadMidiFile",M.prototype.q);w("SMF.Player.prototype.loadMldFile",M.prototype.D);w("SMF.Player.prototype.setLoop",M.prototype.H);w("SMF.Player.prototype.setCC111Loop",M.prototype.F);w("SMF.Player.prototype.setFalcomLoop",M.prototype.G);w("SMF.Player.prototype.setMFiLoop",M.prototype.I);w("SMF.Player.prototype.setWebMidiLink",M.prototype.K);
w("SMF.Player.prototype.getWebMidiLink",M.prototype.C);w("SMF.Player.prototype.setTempoRate",M.prototype.J);w("SMF.Player.prototype.setMasterVolume",M.prototype.w);w("SMF.Player.prototype.getCopyright",M.prototype.A);w("SMF.Player.prototype.getSequenceName",M.prototype.B);}).call(this);
